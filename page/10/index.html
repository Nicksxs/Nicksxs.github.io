<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="2X6S9P7CAjXjVvw8YyQR8pCu-B0oEu7O9quLgxXuWyA">
  <meta name="baidu-site-verification" content="dV8JGNzi0c">
<meta name="chinaz-site-verification" content="500A176AA29CFB31">

<script data-ad-client="ca-pub-7480618470784058" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|M+ 2p:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"nicksxs.me","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="learn from zero,æŠ€æœ¯åšå®¢ï¼ŒNicksxsï¼Œå²å­¦æ£®">
<meta property="og:type" content="website">
<meta property="og:title" content="Nicksxs&#39;s Blog">
<meta property="og:url" content="https://nicksxs.me/page/10/index.html">
<meta property="og:site_name" content="Nicksxs&#39;s Blog">
<meta property="og:description" content="learn from zero,æŠ€æœ¯åšå®¢ï¼ŒNicksxsï¼Œå²å­¦æ£®">
<meta property="og:locale">
<meta property="article:author" content="Nicksxs">
<meta property="article:tag" content="Nicksxs,å²å­¦æ£®,ç±³æ–¹æ–¹,ç±³æ–¹æ–¹çš„ç”·æœ‹å‹,æ£®å“¥">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://nicksxs.me/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>Nicksxs's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-61358619-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-61358619-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?20f33b3c0c0eff9b1522999c0015646d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Nicksxs's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Nicksxs's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">What hurts more, the pain of hard work or the pain of regret?</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="about fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="categories fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archives fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="sitemap fa-fw"></i>Sitemap</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="heartbeat fa-fw"></i>Commonweal 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/nicksxs" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://nicksxs.me/2020/07/19/%E8%81%8A%E8%81%8A-RocketMQ-%E7%9A%84-Broker-%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="Nicksxs">
      <meta itemprop="description" content="learn from zero,æŠ€æœ¯åšå®¢ï¼ŒNicksxsï¼Œå²å­¦æ£®">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nicksxs's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/19/%E8%81%8A%E8%81%8A-RocketMQ-%E7%9A%84-Broker-%E6%BA%90%E7%A0%81/" class="post-title-link" itemprop="url">èŠèŠ RocketMQ çš„ Broker æºç </a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-19 21:48:48" itemprop="dateCreated datePublished" datetime="2020-07-19T21:48:48+08:00">2020-07-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ¶ˆæ¯é˜Ÿåˆ—</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">ä¸­é—´ä»¶</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
            </span>

          
            <span id="/2020/07/19/%E8%81%8A%E8%81%8A-RocketMQ-%E7%9A%84-Broker-%E6%BA%90%E7%A0%81/" class="post-meta-item leancloud_visitors" data-flag-title="èŠèŠ RocketMQ çš„ Broker æºç " title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/07/19/%E8%81%8A%E8%81%8A-RocketMQ-%E7%9A%84-Broker-%E6%BA%90%E7%A0%81/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/07/19/èŠèŠ-RocketMQ-çš„-Broker-æºç /" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>broker çš„å¯åŠ¨å½¢å¼æœ‰ç‚¹ç±»ä¼¼äº NameServerï¼Œéƒ½æ˜¯æœåŠ¡ç±»å‹çš„ï¼Œè·Ÿ Consumer å·®åˆ«æ¯”è¾ƒå¤§ï¼Œ</p>
<p>é¦–å…ˆæ˜¯org.apache.rocketmq.broker.BrokerStartupä¸­çš„ main å‡½æ•°ï¼Œorg.apache.rocketmq.broker.BrokerStartup#createBrokerControlleråŸºæœ¬å°±æ˜¯è¯»å–å‚æ•°ï¼Œè¿™é‡Œå·®ç‚¹æŠŠæœ€æ ¸å¿ƒçš„åˆå§‹åŒ–ç»™æ¼äº†ï¼Œ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">BrokerController</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerController</span><span class="token punctuation">(</span>
                brokerConfig<span class="token punctuation">,</span>
                nettyServerConfig<span class="token punctuation">,</span>
                nettyClientConfig<span class="token punctuation">,</span>
                messageStoreConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// remember all configs to prevent discard</span>
            controller<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerConfig</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> initResult <span class="token operator">=</span> controller<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‰é¢æ˜¯ä»¥ broker é…ç½®ï¼Œnetty çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é…ç½®ï¼Œä»¥åŠæ¶ˆæ¯å­˜å‚¨é…ç½®åœ¨å®ä¾‹åŒ– BrokerControllerï¼Œç„¶åå°±æ˜¯åˆå§‹åŒ–äº†</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicConfigManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerOffsetManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subscriptionGroupManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerFilterManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‰é¢è¿™äº›å°±æ˜¯å„ä¸ªé…ç½®çš„ load äº†ï¼Œç„¶åæ˜¯ä¸ªæˆ‘è®¤ä¸ºæ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†messageStore çš„å®ä¾‹åŒ–ï¼Œ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStatsManager<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageArrivingListener<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">DLedgerRoleChangeHandler</span> roleChangeHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerRoleChangeHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">DefaultMessageStore</span><span class="token punctuation">)</span> messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DLedgerCommitLog</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultMessageStore</span><span class="token punctuation">)</span> messageStore<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getdLedgerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getdLedgerLeaderElector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addRoleChangeHandler</span><span class="token punctuation">(</span>roleChangeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerStats</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultMessageStore</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//load plugin</span>
        <span class="token class-name">MessageStorePluginContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageStorePluginContext</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">,</span> brokerStatsManager<span class="token punctuation">,</span> messageArrivingListener<span class="token punctuation">,</span> brokerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore <span class="token operator">=</span> <span class="token class-name">MessageStoreFactory</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">getDispatcherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherCalcBitMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerFilterManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to initialize"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…ˆæ˜¯å®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–æ„é€ å‡½æ•°é‡Œçš„ä»£ç æ¯”è¾ƒé‡è¦ï¼Œé‡ç‚¹çœ‹ä¸€ä¸‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MessageStoreConfig</span> messageStoreConfig<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">BrokerStatsManager</span> brokerStatsManager<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">MessageArrivingListener</span> messageArrivingListener<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">BrokerConfig</span> brokerConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageArrivingListener <span class="token operator">=</span> messageArrivingListener<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig <span class="token operator">=</span> brokerConfig<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig <span class="token operator">=</span> messageStoreConfig<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStatsManager <span class="token operator">=</span> brokerStatsManager<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AllocateMappedFileService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerCommitLog</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitLog</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>flushConsumeQueueService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlushConsumeQueueService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cleanCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CleanCommitLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cleanConsumeQueueService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CleanConsumeQueueService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storeStatsService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StoreStatsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>haService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HAService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>haService <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reputMessageService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReputMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduleMessageService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleMessageService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>transientStorePool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransientStorePool</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isTransientStorePoolEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>transientStorePool<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>indexService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherBuildConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherBuildIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token class-name">StorePathConfigHelper</span><span class="token punctuation">.</span><span class="token function">getLockFile</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MappedFile</span><span class="token punctuation">.</span><span class="token function">ensureDirOK</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lockFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œé¢æœ‰å¾ˆå¤šç±»ï¼Œä¸è¿‡å…ˆæŠŠä»æ„é€ å‡½æ•°é‡Œä¼ è¿›æ¥çš„å¿½ç•¥ä¸‹ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ <code>AllocateMappedFileService</code> è¿™ä¸ªserviceï¼Œå‰é¢çœ‹è¿‡æ–‡ç« çš„å¯èƒ½ä¼šæ ¹æ®ä¸Šé¢çš„ä»£ç çŒœåˆ°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ª ServiceThreadï¼Œå¦‚æœæ˜¯å¯¹RocketMQ æœ‰æ‰€äº†è§£çš„å¯èƒ½ä»åå­—å¯ä»¥çœ‹å‡ºè¿™ä¸ªç±»æ˜¯å…³äº RocketMQ æ¶ˆæ¯æ€ä¹ˆè½ç›˜çš„ï¼Œå½“éœ€è¦åˆ›å»ºMappedFileæ—¶ï¼ˆåœ¨MapedFileQueue.getLastMapedFileæ–¹æ³•ä¸­ï¼‰ï¼Œå‘è¯¥çº¿ç¨‹çš„requestQueueé˜Ÿåˆ—ä¸­æ”¾å…¥AllocateRequestè¯·æ±‚å¯¹è±¡ï¼Œè¯¥çº¿ç¨‹ä¼šåœ¨åå°ç›‘å¬è¯¥é˜Ÿåˆ—ï¼Œå¹¶åœ¨åå°åˆ›å»ºMapedFileå¯¹è±¡ï¼Œå³åŒæ—¶åˆ›å»ºäº†ç‰©ç†æ–‡ä»¶ã€‚ç„¶åæ˜¯åˆ›å»ºäº† IndexService æœåŠ¡çº¿ç¨‹ï¼Œç”¨æ¥ç»™åˆ›å»ºç´¢å¼•ï¼›è¿˜æœ‰æ˜¯FlushConsumeQueueServiceæ˜¯å°†ConsumeQueue åˆ·å…¥ç£ç›˜ï¼›CleanCommitLogServiceç”¨æ¥æ¸…ç†è¿‡æœŸçš„ CommitLogï¼Œé»˜è®¤æ˜¯ 72 å°æ—¶ä»¥ä¸Šï¼›CleanConsumeQueueServiceæ˜¯å°†å°äºæœ€æ–°çš„ CommitLog åç§»é‡çš„ ConsumeQueue æ¸…ç†æ‰ï¼›StoreStatsServiceæ˜¯å‚¨å­˜ç»Ÿè®¡æœåŠ¡ï¼›HAServiceç”¨äºCommitLog çš„ä¸»å¤‡åŒæ­¥ï¼›ScheduleMessageServiceç”¨äºå®šæ—¶æ¶ˆæ¯ï¼›è¿˜æœ‰å°±æ˜¯è¿™ä¸ªReputMessageServiceéå¸¸é‡è¦ï¼Œå°±æ˜¯ç”±å®ƒå®ç°äº†å°† CommitLog ä»¥ topic+queue çº¬åº¦æ„å»º ConsumeQueueï¼Œåé¢TransientStorePoolæ˜¯å¼‚æ­¥åˆ·ç›˜æ—¶çš„å­˜å‚¨bufferï¼Œä¹Ÿå¯ä»¥ä»åé¢çš„åˆ¤æ–­ä¸­çœ‹å‡ºæ¥</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isTransientStorePoolEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> transientStorePoolEnable <span class="token operator">&amp;&amp;</span> <span class="token class-name">FlushDiskType</span><span class="token punctuation">.</span>ASYNC_FLUSH <span class="token operator">==</span> <span class="token function">getFlushDiskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token class-name">BrokerRole</span><span class="token punctuation">.</span>SLAVE <span class="token operator">!=</span> <span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>å†ç„¶åå°±æ˜¯å¯åŠ¨ä¸¤ä¸ªæœåŠ¡çº¿ç¨‹ï¼ŒdispatcherListæ˜¯ä¸ºCommitLogæ–‡ä»¶è½¬å‘è¯·æ±‚ï¼Œå·®ä¸å¤šè¿™ä¸ªåˆå§‹åŒ–å°±è¿™äº›å†…å®¹ã€‚</p>
<p>ç„¶åå›åˆ°å¤–å±‚ï¼Œä¸‹é¢æ˜¯ä¸»å¤‡åˆ‡æ¢çš„é…ç½®ï¼Œç„¶åæ˜¯æ•°æ®ç»Ÿè®¡ï¼Œæ¥ç€æ˜¯å­˜å‚¨æ’ä»¶åŠ è½½ï¼Œç„¶åæ˜¯å¾€è½¬å‘å™¨é“¾è¡¨é‡Œå†åŠ ä¸€ä¸ªè¿‡æ»¤å™¨</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">DLedgerRoleChangeHandler</span> roleChangeHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerRoleChangeHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">DefaultMessageStore</span><span class="token punctuation">)</span> messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DLedgerCommitLog</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultMessageStore</span><span class="token punctuation">)</span> messageStore<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getdLedgerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getdLedgerLeaderElector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addRoleChangeHandler</span><span class="token punctuation">(</span>roleChangeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerStats</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultMessageStore</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//load plugin</span>
        <span class="token class-name">MessageStorePluginContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageStorePluginContext</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">,</span> brokerStatsManager<span class="token punctuation">,</span> messageArrivingListener<span class="token punctuation">,</span> brokerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore <span class="token operator">=</span> <span class="token class-name">MessageStoreFactory</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">getDispatcherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherCalcBitMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerFilterManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¥ä¸‹æ¥å°±æ˜¯org.apache.rocketmq.store.MessageStore#loadçš„è¿‡ç¨‹äº†ï¼Œ</p>
<ol>
<li>è°ƒç”¨ScheduleMessageService.loadæ–¹æ³•ï¼Œåˆå§‹åŒ–å»¶è¿Ÿçº§åˆ«åˆ—è¡¨ã€‚å°†è¿™äº›çº§åˆ«ï¼ˆâ€1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2hâ€ï¼‰çš„å»¶æ—¶å­˜å…¥å»¶è¿Ÿçº§åˆ«delayLevelTableï¼šConcurrentHashMap&lt;Integer /* level */, Long/* delay timeMillis */&gt;å˜é‡ä¸­ï¼Œä¾‹å¦‚1sçš„kvå€¼ä¸º1:1000,5sçš„kvå€¼ä¸º2:5000ï¼Œkeyå€¼ä¾æ¬¡ç±»æ¨ï¼›æ¯ä¸ªå»¶è¿Ÿçº§åˆ«å³ä¸ºä¸€ä¸ªé˜Ÿåˆ—ã€‚</li>
</ol>
<p>2)è°ƒç”¨CommitLog.loadæ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­è°ƒç”¨MapedFileQueue.loadæ–¹æ³•ï¼Œå°†$HOME /store/commitlogç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŠ è½½åˆ°MapedFileQueueçš„List<MapedFile>å˜é‡ä¸­ï¼›</p>
<p>3)è°ƒç”¨DefaultMessageStore.loadConsumeQueueæ–¹æ³•åŠ è½½consumequeueæ–‡ä»¶æ•°æ®åˆ°DefaultMessageStore.consumeQueueTableé›†åˆä¸­ã€‚</p>
<p>åˆå§‹åŒ–StoreCheckPointå¯¹è±¡ï¼ŒåŠ è½½$HOME/store/checkpointæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶è®°å½•ä¸‰ä¸ªå­—æ®µå€¼ï¼Œåˆ†åˆ«æ˜¯ç‰©ç†é˜Ÿåˆ—æ¶ˆæ¯æ—¶é—´æˆ³ã€é€»è¾‘é˜Ÿåˆ—æ¶ˆæ¯æ—¶é—´æˆ³ã€ç´¢å¼•é˜Ÿåˆ—æ¶ˆæ¯æ—¶é—´æˆ³ã€‚</p>
<p>è°ƒç”¨IndexService.loadæ–¹æ³•åŠ è½½$HOME/store/indexç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚å¯¹è¯¥ç›®å½•ä¸‹çš„æ¯ä¸ªæ–‡ä»¶åˆå§‹åŒ–ä¸€ä¸ªIndexFileå¯¹è±¡ã€‚ç„¶åè°ƒç”¨IndexFileå¯¹è±¡çš„loadæ–¹æ³•å°†IndexHeaderåŠ è½½åˆ°å¯¹è±¡çš„å˜é‡ä¸­ï¼›å†æ ¹æ®æ£€æŸ¥æ˜¯å¦å­˜åœ¨abortæ–‡ä»¶ï¼Œè‹¥æœ‰å­˜åœ¨abortæ–‡ä»¶ï¼Œåˆ™è¡¨ç¤ºBrokerè¡¨ç¤ºä¸Šæ¬¡æ˜¯å¼‚å¸¸é€€å‡ºçš„ï¼Œåˆ™æ£€æŸ¥checkpointçš„indexMsgTimestampå­—æ®µå€¼æ˜¯å¦å°äºIndexHeaderçš„endTimestampå€¼ï¼ŒindexMsgTimestampå€¼è¡¨ç¤ºæœ€ååˆ·ç›˜çš„æ—¶é—´ï¼Œè‹¥å°äºåˆ™è¡¨ç¤ºåœ¨æœ€ååˆ·ç›˜ä¹‹ååœ¨è¯¥æ–‡ä»¶ä¸­è¿˜åˆ›å»ºäº†ç´¢å¼•ï¼Œåˆ™è¦åˆ é™¤è¯¥Indexæ–‡ä»¶ï¼Œå¦åˆ™å°†è¯¥IndexFileå¯¹è±¡æ”¾å…¥indexFileList:ArrayList<IndexFile>ç´¢å¼•æ–‡ä»¶é›†åˆä¸­ã€‚</p>
<p>ç„¶åè°ƒç”¨org.apache.rocketmq.store.DefaultMessageStore#recoveræ¢å¤ï¼Œå‰é¢æœ‰æ ¹æ®<code>boolean lastExitOK = !this.isTempFileExist();</code>ä¸´æ—¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨æ¥åˆ¤æ–­ä¸Šä¸€æ¬¡æ˜¯å¦æ­£å¸¸é€€å‡ºï¼Œæ ¹æ®è¿™ä¸ªçŠ¶æ€æ¥é€‰æ‹©ä»€ä¹ˆæ¢å¤ç­–ç•¥</p>
<p>æ¥ä¸‹å»æ˜¯åˆå§‹åŒ– Netty æœåŠ¡ç«¯ï¼Œåˆå§‹åŒ–å‘é€æ¶ˆæ¯çº¿ç¨‹æ± ï¼ˆsendMessageExecutorï¼‰ã€æ‹‰å–æ¶ˆæ¯çº¿ç¨‹æ± ï¼ˆpullMessageExecutorï¼‰ã€ç®¡ç†Brokerçº¿ç¨‹æ± ï¼ˆadminBrokerExecutorï¼‰ã€å®¢æˆ·ç«¯ç®¡ç†çº¿ç¨‹æ± ï¼ˆclientManageExecutorï¼‰ï¼Œæ³¨å†Œäº‹ä»¶å¤„ç†å™¨ï¼ŒåŒ…æ‹¬å‘é€æ¶ˆæ¯äº‹ä»¶å¤„ç†å™¨ï¼ˆSendMessageProcessorï¼‰ã€æ‹‰å–æ¶ˆæ¯äº‹ä»¶å¤„ç†å™¨ã€æŸ¥è¯¢æ¶ˆæ¯äº‹ä»¶å¤„ç†å™¨ï¼ˆQueryMessageProcessorï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯çš„å¿ƒè·³äº‹ä»¶ã€æ³¨é”€äº‹ä»¶ã€è·å–æ¶ˆè´¹è€…åˆ—è¡¨äº‹ä»¶ã€æ›´æ–°æ›´æ–°å’ŒæŸ¥è¯¢æ¶ˆè´¹è¿›åº¦consumerOffsetï¼‰ã€å®¢æˆ·ç«¯ç®¡ç†äº‹ä»¶å¤„ç†å™¨ï¼ˆClientManageProcessorï¼‰ã€ç»“æŸäº‹åŠ¡å¤„ç†å™¨ï¼ˆEndTransactionProcessorï¼‰ã€é»˜è®¤äº‹ä»¶å¤„ç†å™¨ï¼ˆAdminBrokerProcessorï¼‰ï¼Œç„¶åæ˜¯å®šæ—¶ä»»åŠ¡</p>
<p><code>BrokerController.this.getBrokerStats().record();</code> è®°å½• Broker çŠ¶æ€</p>
<p><code>BrokerController.this.consumerOffsetManager.persist();</code> æŒä¹…åŒ–consumerOffset</p>
<p><code>BrokerController.this.consumerFilterManager.persist();</code>æŒä¹…åŒ–consumerFilter</p>
<p><code>BrokerController.this.protectBroker();</code> ä¿æŠ¤ brokerï¼Œæ¶ˆè´¹æ…¢ï¼Œä¸è®©ç»§ç»­æŠ•é€’</p>
<p><code>BrokerController.this.printWaterMark();</code> æ‰“å°æ°´ä½</p>
<p><code>log.info(&quot;dispatch behind commit log &#123;&#125; bytes&quot;, BrokerController.this.getMessageStore().dispatchBehindBytes());</code> æ£€æŸ¥è½åç¨‹åº¦</p>
<p><code>BrokerController.this.brokerOuterAPI.fetchNameServerAddr();</code> å®šæ—¶è·å– nameserver</p>
<p><code>BrokerController.this.printMasterAndSlaveDiff();</code> æ‰“å°ä¸»ä»ä¸ä¸€è‡´</p>
<p>ç„¶åæ˜¯ tslï¼Œåˆå§‹åŒ–äº‹åŠ¡æ¶ˆæ¯ï¼Œåˆå§‹åŒ– RPCHook</p>
<p>è¯·æŠŠå®³æ€•æ‰“åˆ°å…¬å±ä¸ŠğŸ¤¦â€â™‚ï¸ï¼Œä»çº¿ç¨‹æ± åå­—å’Œè°ƒç”¨çš„æ–¹æ³•åº”è¯¥å¯ä»¥çœ‹å‡ºå¤§éƒ¨åˆ†çš„ç”¨é€”</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyRemotingServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nettyServerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientHousekeepingService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">NettyServerConfig</span> fastConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">NettyServerConfig</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fastConfig<span class="token punctuation">.</span><span class="token function">setListenPort</span><span class="token punctuation">(</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">getListenPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyRemotingServer</span><span class="token punctuation">(</span>fastConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientHousekeepingService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getSendMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getSendMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>sendThreadPoolQueue<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"SendMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getPullMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getPullMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>pullThreadPoolQueue<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"PullMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>replyMessageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getProcessReplyMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getProcessReplyMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>replyThreadPoolQueue<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"ProcessReplyMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getQueryMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getQueryMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>queryThreadPoolQueue<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"QueryMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>adminBrokerExecutor <span class="token operator">=</span>
                <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getAdminBrokerThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span>
                    <span class="token string">"AdminBrokerThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getClientManageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getClientManageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>clientManagerThreadPoolQueue<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"ClientManageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getHeartbeatThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getHeartbeatThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatThreadPoolQueue<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"HeartbeatThread_"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>endTransactionExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getEndTransactionThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getEndTransactionThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>endTransactionThreadPoolQueue<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"EndTransactionThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor <span class="token operator">=</span>
                <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getConsumerManageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span>
                    <span class="token string">"ConsumerManageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">long</span> initialDelay <span class="token operator">=</span> <span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">computeNextMorningTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> period <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">BrokerController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBrokerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">record</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"schedule record error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> initialDelay<span class="token punctuation">,</span> period<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">BrokerController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumerOffsetManager<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"schedule persist consumerOffset error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getFlushConsumerOffsetInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">BrokerController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumerFilterManager<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"schedule persist consumer filter error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">BrokerController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">protectBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"protectBroker error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">BrokerController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">printWaterMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"printWaterMark error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"dispatch behind commit log &#123;&#125; bytes"</span><span class="token punctuation">,</span> <span class="token class-name">BrokerController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispatchBehindBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"schedule dispatchBehindBytes error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerOuterAPI<span class="token punctuation">.</span><span class="token function">updateNameServerAddressList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Set user specified name server address: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">isFetchNamesrvAddrByAddressServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">BrokerController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerOuterAPI<span class="token punctuation">.</span><span class="token function">fetchNameServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"ScheduledTask fetchNameServerAddr exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BrokerRole</span><span class="token punctuation">.</span>SLAVE <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getHaMasterAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getHaMasterAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">updateHaMasterAddress</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getHaMasterAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>updateMasterHAServerAddrPeriodically <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>updateMasterHAServerAddrPeriodically <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                                <span class="token class-name">BrokerController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">printMasterAndSlaveDiff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"schedule printMasterAndSlaveDiff error."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsMode <span class="token operator">!=</span> <span class="token class-name">TlsMode</span><span class="token punctuation">.</span>DISABLED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Register a listener to reload SslContext</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    fileWatchService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWatchService</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerCertPath<span class="token punctuation">,</span>
                            <span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerKeyPath<span class="token punctuation">,</span>
                            <span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerTrustCertPath
                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">FileWatchService<span class="token punctuation">.</span>Listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">boolean</span> certChanged<span class="token punctuation">,</span> keyChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                            <span class="token annotation punctuation">@Override</span>
                            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onChanged</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerTrustCertPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"The trust certificate changed, reload the ssl context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token function">reloadServerSslContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerCertPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    certChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerKeyPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    keyChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>certChanged <span class="token operator">&amp;&amp;</span> keyChanged<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"The certificate and private key changed, reload the ssl context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    certChanged <span class="token operator">=</span> keyChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                                    <span class="token function">reloadServerSslContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">&#125;</span>

                            <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reloadServerSslContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NettyRemotingServer</span><span class="token punctuation">)</span> remotingServer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadSslContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NettyRemotingServer</span><span class="token punctuation">)</span> fastRemotingServer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadSslContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"FileWatchService created error, can't load the certificate dynamically"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">initialTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">initialAcl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">initialRpcHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>Broker å¯åŠ¨è¿‡ç¨‹</p>
<p>è´´ä»£ç </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStore <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileWatchService <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fileWatchService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerOuterAPI <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerOuterAPI<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestHoldService <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestHoldService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clientHousekeepingService <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>clientHousekeepingService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filterServerManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>filterServerManager<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">startProcessorByHa</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">handleSlaveSynchronize</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBrokerAll</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">BrokerController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBrokerAll</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> brokerConfig<span class="token punctuation">.</span><span class="token function">isForceRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"registerBrokerAll Exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getRegisterNameServerPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerStatsManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStatsManager<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerFastFailure <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerFastFailure<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>


    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é¦–å…ˆæ˜¯å¯åŠ¨messageStoreï¼Œè°ƒç”¨ start æ–¹æ³•ï¼Œè¿™é‡Œé¢åˆè°ƒç”¨äº†ä¸€äº›ä»£ç </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

        lock <span class="token operator">=</span> lockFile<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> lock<span class="token punctuation">.</span><span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Lock failed,MQ already started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        lockFile<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lockFile<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">/**
             * 1. Make sure the fast-forward messages to be truncated during the recovering according to the max physical offset of the commitlog;
             * 2. DLedger committedPos may be missing, so the maxPhysicalPosInLogicQueue maybe bigger that maxOffset returned by DLedgerCommitLog, just let it go;
             * 3. Calculate the reput offset according to the consume queue;
             * 4. Make sure the fall-behind messages to be dispatched before starting the commitlog, especially when the broker role are automatically changed.
             */</span>
            <span class="token keyword">long</span> maxPhysicalPosInLogicQueue <span class="token operator">=</span> commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ConsumeQueue</span><span class="token punctuation">></span></span> maps <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueTable<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumeQueue</span> logic <span class="token operator">:</span> maps<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logic<span class="token punctuation">.</span><span class="token function">getMaxPhysicOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> maxPhysicalPosInLogicQueue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        maxPhysicalPosInLogicQueue <span class="token operator">=</span> logic<span class="token punctuation">.</span><span class="token function">getMaxPhysicOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxPhysicalPosInLogicQueue <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                maxPhysicalPosInLogicQueue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxPhysicalPosInLogicQueue <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                maxPhysicalPosInLogicQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/**
                 * This happens in following conditions:
                 * 1. If someone removes all the consumequeue files or the disk get damaged.
                 * 2. Launch a new broker, and copy the commitlog from other brokers.
                 *
                 * All the conditions has the same in common that the maxPhysicalPosInLogicQueue should be 0.
                 * If the maxPhysicalPosInLogicQueue is gt 0, there maybe something wrong.
                 */</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[TooSmallCqOffset] maxPhysicalPosInLogicQueue=&#123;&#125; clMinOffset=&#123;&#125;"</span><span class="token punctuation">,</span> maxPhysicalPosInLogicQueue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[SetReputOffset] maxPhysicalPosInLogicQueue=&#123;&#125; clMinOffset=&#123;&#125; clMaxOffset=&#123;&#125; clConfirmedOffset=&#123;&#125;"</span><span class="token punctuation">,</span>
                maxPhysicalPosInLogicQueue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getConfirmOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reputMessageService<span class="token punctuation">.</span><span class="token function">setReputFromOffset</span><span class="token punctuation">(</span>maxPhysicalPosInLogicQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reputMessageService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/**
             *  1. Finish dispatching the messages fall behind, then to start other services.
             *  2. DLedger committedPos may be missing, so here just require dispatchBehindBytes &lt;= 0
             */</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dispatchBehindBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Try to finish doing reput the messages fall behind during the starting, reputOffset=&#123;&#125; maxOffset=&#123;&#125; behind=&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reputMessageService<span class="token punctuation">.</span><span class="token function">getReputFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMaxPhyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchBehindBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recoverTopicQueueTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleScheduleMessageService</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>flushConsumeQueueService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storeStatsService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addScheduleTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shutdown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>è°ƒç”¨DefaultMessageStore.startæ–¹æ³•å¯åŠ¨DefaultMessageStoreå¯¹è±¡ä¸­çš„ä¸€äº›æœåŠ¡çº¿ç¨‹ã€‚</p>
<ol>
<li>å¯åŠ¨ReputMessageServiceæœåŠ¡çº¿ç¨‹</li>
<li>å¯åŠ¨FlushConsumeQueueServiceæœåŠ¡çº¿ç¨‹ï¼›</li>
<li>è°ƒç”¨CommitLog.startæ–¹æ³•ï¼Œå¯åŠ¨CommitLogå¯¹è±¡ä¸­çš„FlushCommitLogServiceçº¿ç¨‹æœåŠ¡ï¼Œè‹¥æ˜¯åŒæ­¥åˆ·ç›˜ï¼ˆSYNC_FLUSHï¼‰åˆ™æ˜¯å¯åŠ¨GroupCommitServiceçº¿ç¨‹æœåŠ¡ï¼›è‹¥æ˜¯å¼‚æ­¥åˆ·ç›˜ï¼ˆASYNC_FLUSHï¼‰åˆ™æ˜¯å¯åŠ¨FlushRealTimeServiceçº¿ç¨‹æœåŠ¡ï¼›</li>
<li>å¯åŠ¨StoreStatsServiceçº¿ç¨‹æœåŠ¡ï¼›</li>
<li>å¯åŠ¨å®šæ—¶æ¸…ç†ä»»åŠ¡</li>
</ol>
<p>ç„¶åæ˜¯å¯åŠ¨ClientHousekeepingServiceçš„ netty æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œç„¶åæ˜¯å¯åŠ¨fileWatchServiceè¯ä¹¦æœåŠ¡ï¼Œæ¥ç€å¯åŠ¨BrokerOuterAPIä¸­çš„NettyRemotingClientï¼Œå³å»ºç«‹ä¸NameServerçš„é“¾æ¥ï¼Œç”¨äºè‡ªèº«Brokerä¸å…¶ä»–æ¨¡å—çš„RPCåŠŸèƒ½è°ƒç”¨ï¼›åŒ…æ‹¬è·å–NameServerçš„åœ°å€ã€æ³¨å†ŒBrokerã€æ³¨é”€Brokerã€è·å–Topicé…ç½®ã€è·å–æ¶ˆæ¯è¿›åº¦ä¿¡æ¯ã€è·å–è®¢é˜…å…³ç³»ç­‰RPCåŠŸèƒ½ï¼Œç„¶åæ˜¯PullRequestHoldServiceæœåŠ¡çº¿ç¨‹ï¼Œè¿™ä¸ªå°±æ˜¯å®ç°é•¿è½®è¯¢çš„ï¼Œç„¶åå¯åŠ¨ç®¡å®¶ClientHousekeepingServiceæœåŠ¡ï¼Œè´Ÿè´£æ‰«æä¸æ´»è·ƒçš„ç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…å’Œ filterï¼Œå¯åŠ¨FilterServerManager è¿‡æ»¤å™¨æœåŠ¡ç®¡ç†ï¼Œç„¶åå¯åŠ¨å®šæ—¶ä»»åŠ¡è°ƒç”¨org.apache.rocketmq.broker.BrokerController#registerBrokerAllå‘æ‰€æœ‰ nameserver æ³¨å†Œ brokerï¼Œæœ€åæ˜¯æŒ‰éœ€å¼€å¯org.apache.rocketmq.store.stats.BrokerStatsManagerå’Œorg.apache.rocketmq.broker.latency.BrokerFastFailureï¼ŒåŸºæœ¬ä¸Šå¯åŠ¨è¿‡ç¨‹å°±å®Œæˆäº†</p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://nicksxs.me/2020/07/11/2020%E5%B9%B4%E4%B8%AD%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="Nicksxs">
      <meta itemprop="description" content="learn from zero,æŠ€æœ¯åšå®¢ï¼ŒNicksxsï¼Œå²å­¦æ£®">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nicksxs's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/11/2020%E5%B9%B4%E4%B8%AD%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">2020å¹´ä¸­æ€»ç»“</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-11 23:20:38" itemprop="dateCreated datePublished" datetime="2020-07-11T23:20:38+08:00">2020-07-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB/" itemprop="url" rel="index"><span itemprop="name">ç”Ÿæ´»</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB/%E5%B9%B4%E4%B8%AD%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">å¹´ä¸­æ€»ç»“</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB/%E5%B9%B4%E4%B8%AD%E6%80%BB%E7%BB%93/2020/" itemprop="url" rel="index"><span itemprop="name">2020</span></a>
                </span>
            </span>

          
            <span id="/2020/07/11/2020%E5%B9%B4%E4%B8%AD%E6%80%BB%E7%BB%93/" class="post-meta-item leancloud_visitors" data-flag-title="2020å¹´ä¸­æ€»ç»“" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/07/11/2020%E5%B9%B4%E4%B8%AD%E6%80%BB%E7%BB%93/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/07/11/2020å¹´ä¸­æ€»ç»“/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>å¾ˆå¿«2020 å¹´å°±è¿‡äº†ä¸€åŠäº†ï¼Œè€Œä¸”æ˜¯ä»Šå¹´è¿™ä¹ˆç‰¹æ®Šçš„ä¸€å¹´ï¼Œå¾ˆå¤šäº‹æƒ…éƒ½å‘ç”Ÿçš„å‡ºä¹æ„æ–™ï¼Œç–«æƒ…è¿™ä¸ªç»•ä¸è¿‡å»çš„è¯é¢˜ï¼Œä¹‹å‰å†™äº†ç‚¹æ¯”è¾ƒæ„¤é’çš„æ–‡å­—ï¼Œæ„Ÿè§‰ä¸å¤ªé€‚åˆå‘å‡ºæ¥å°±çƒ‚åœ¨è‰ç¨¿ç®±é‡Œå§ï¼Œè¿™ä¸ªç›®å‰ä¸€å¤§å½±å“ä¼°è®¡æ˜¯ä»Šå¹´éƒ½æ²¡åŠæ³•å®Œå…¨æ‘˜ä¸‹å£ç½©äº†ï¼Œå‰é¢å‡ ä¸ªæœˆæ¥å›æ­å·éƒ½å¼€è½¦ï¼Œå› ä¸ºå½­åŸ å¤§æ¡¥ä¸é€šè¡Œäº†ï¼Œå®åœ¨æ˜¯éå¸¸ä¸æ–¹ä¾¿ï¼Œæ¯æ¡è·¯éƒ½ç°å¸¸å µï¼Œå¿ƒç´¯ï¼Œåæ§½ä¸‹æ­å·çš„äº¤é€šè§„åˆ’å’Œäº¤è­¦åŒå¿—ï¼Œå·¥ä½œå®åœ¨åšçš„ä¸å’‹åœ°ã€‚</p>
<p>å¦å¤–ä¸€ä»¶æ˜¯å°±æ˜¯èœ—å£³ï¼Œä»å‰ä¸çŸ¥é“é»é»‘èœ—å£³æ˜¯å•¥æ„æ€ï¼Œåªæ˜¯ç»å¸¸ä¼šåœ¨ä»–çš„è§†é¢‘é‡Œçœ‹åˆ°ï¼Œå¤§å­¦çš„æ—¶å€™åœ¨ç¼˜ç½‘ä¸‹äº†ä¸€ä¸ªé›†é”¦ï¼Œç‚’é¸¡å¸…æ°”ï¼Œå„ç§ç©ºæ¥æ‰£ç¯®ï¼Œè¶Šæ¥è¶Šèƒ½æ˜ç™½é‚£å¥â€œä½ æ°¸è¿œä¸çŸ¥é“æ„å¤–å’Œæ˜å¤©ä¸çŸ¥é“å“ªä¸ªä¼šå…ˆæ¥,ä¸”è¡Œä¸”çæƒœâ€çš„å«ä¹‰ï¼Œåªæ˜¯å¬äº†å¾ˆå¤šé“ç†ï¼Œä¾ç„¶æ´»ä¸å¥½è¿™ä¸€ç”Ÿï¼ŒçŸ¥æ˜“è¡Œéš¾ï¼Œç‹é˜³æ˜çœŸçš„æ˜¯è¿™æ–¹é¢çš„å¤§å¸ˆï¼Œæœ‰ç©ºå¯ä»¥çœ‹çœ‹è¿™æ–¹é¢çš„ä¹¦ï¼Œä¸€ç›´æƒ³å†™å†™æˆ‘è·Ÿç¯®çƒè·Ÿèœ—å£³çš„è¿™åå‡ å¹´ï¼Œäº‰å–èƒ½æ—©æ—¥å†™å¥½å§ï¼Œä¸è¿‡å¾—æ‰¾ä¸ªé™å¾—ä¸‹æ¥çš„æ—¶å€™å†™ã€‚</p>
<p>æ­£äº‹æ–¹é¢ä¸ŠåŠå¹´è¿˜æ˜¯æŒºè®©äººå¤±æœ›çš„ï¼Œæ²¡æœ‰è¾¾æˆä¸€äº›ç›®æ ‡ï¼Œåº”è¯¥è¿˜æ˜¯èƒ½åŠ›ä¸è¶³å§ï¼ŒæŠ€æœ¯æ–¹é¢åˆ†æä¸€ä¸‹è¿˜æ˜¯åœç•™åœ¨çœ‹çš„è¡¨é¢å±‚ï¼Œæœ‰äº›å®æ“çš„ï¼Œæˆ–è€…ç»“åˆä¸šåŠ¡åœºæ™¯çš„èƒ½åŠ›ä¸å¤ªè¡Œï¼Œç®—æ˜¯åœ¨åšæŒå†™å†™ blogï¼Œä¸»è¦æ˜¯è¢«è¿™ä¸ªæ¯å‘¨ä¸€ç¯‡çš„ç›®æ ‡æ¨ç€èµ°ï¼Œæœ‰æ—¶ä¼šæ¯”è¾ƒç„¦è™‘ï¼Œå†…å®¹äº§å‡ºä¹Ÿè¿˜æ¯”è¾ƒå·®ï¼Œå¸Œæœ›èƒ½åœ¨åé¢æœ‰äº›æ”¹å–„ï¼Œå¯èƒ½ä¼šé™ä½é¢‘ç‡ï¼Œåªæ˜¯è§‰å¾—é™ä½äº†ä¹Ÿä¸ä¸€å®šèƒ½æœ‰æ¯”è¾ƒå¥½çš„æå‡ï¼Œæ— æ³•æˆ˜èƒœè‡ªå·±çš„æƒ°æ€§ï¼Œæ‰€ä»¥æš‚æ—¶è¿˜æ˜¯åšæŒä¸‹è¿™ä¸ªç›®æ ‡å§ï¼Œè¿˜æœ‰å°±æ˜¯ coding èƒ½åŠ›ï¼Œæœ‰æ—¶å€™ä¹Ÿåº”è¯¥åˆ·åˆ·é¢˜ï¼Œæå‡æ€ç»´æ•æ·åº¦ï¼Œå¤§è„‘ç”¨å¤ªå°‘å¯èƒ½ç”Ÿé”ˆäº†ï¼Œå†µä¸”æœ¬æ¥å°±ä¸æ˜¯å¾ˆæœ‰ä¼˜åŠ¿ï¼Œè™½ç„¶å¤±æœ›ä¹Ÿåªèƒ½ç»§ç»­åŠªåŠ›å§ï¼Œæ—¥æ‹±ä¸€å’ï¼Œæ¥æ—¥æ–¹é•¿ï¼ŒåŠ æ²¹å§~ğŸ˜”</p>
<p>è¿˜æœ‰å°±æ˜¯è·‘æ­¥å‡è‚¥äº†ï¼Œæˆªæ­¢ä»Šå¤©ï¼Œä¸ŠåŠå¹´è·‘äº† 136 å…¬é‡Œäº†ï¼Œå› ä¸ºç–«æƒ…å½±å“ï¼Œå†œå†å¹´åæ˜¯ä» 4 æœˆ 17 å·å¼€å§‹è·‘çš„ï¼Œå»å¹´è·‘åˆ°äº† 300 å…¬é‡Œï¼Œå¥–åŠ±è‡ªå·±äº†ä¸€ä¸ªæ‰‹è¡¨ï¼ˆçœŸçš„æŒºåæ‚”çš„ï¼Œè¿˜ä¸å¦‚ 200 å—ä¹°ä¸ªæ‰‹è¡¨ï¼‰ï¼Œä»Šå¹´å¸Œæœ›å¯ä»¥èƒ½åœ¨è¿™ä¸ªåŸºç¡€ä¸Šå†è¿›ä¸€æ­¥ï¼Œä¸€ç›´è·Ÿé¢†å¯¼è¯´ï¼Œè·‘æ­¥ç®—æ˜¯æˆ‘åšæŒä¸‹æ¥çš„å”¯ä¸€ä¸€ä¸ªå¥½ä¹ æƒ¯äº†ï¼Œ618 ä¹°äº†ä¸ªè·‘æ­¥æœºï¼Œå‘¨æœ«å›å®¶äº†å¯ä»¥ä¸å—å¤©æ°”å½±å“çš„å¤šè·‘è·‘ï¼Œä¸è¿‡å¦‚æœå¤©æ°”å¥½å¯èƒ½è¿˜æ˜¯ä¼šå‡ºå»è·‘è·‘ï¼Œè·‘æ­¥æœºè·‘é“å¤šå°‘è¿˜æ˜¯æœ‰ç‚¹æ‹˜æŸï¼Œåªæ˜¯æ„Ÿè§‰å¯èƒ½æ˜¯æˆ‘è¿˜æ˜¯åƒå¾—å¤ªå¤šäº†ğŸ¤¦â€â™‚ï¸ï¼Œæ•ˆæœä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œè¿˜åœ¨ 80 è¿™ä¸ªåå¾˜å¾Šï¼Œç­‰äºæµªè´¹äº†å¤§åŠå¹´ï¼Œå¯èƒ½æ˜¯å¹´åˆçš„é¡¹ç›®å¤ªè´¹å¿ƒåŠ›ï¼Œå‹åŠ›æ¯”è¾ƒå¤§ï¼Œåƒå¾—æ›´å¤šï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç®—å·¥ä¼¤ğŸ˜„ï¼Œè¿™æ–¹é¢ä¹Ÿéœ€è¦å¥½å¥½è°ƒæ•´ï¼Œå¯ä»¥æ”¾å¾—å¼€ä¸€ç‚¹ï¼Œè™½ç„¶ä¸å¤ªå¯èƒ½ä¸€ä¸‹å­åˆ°ä½ï¼Œä½†æ˜¯æ€»è¦å»åŠªåŠ›ä¸‹ï¼Œéšç€å¹´é¾„æˆé•¿æ€»è¦æ‰¿æ‹…æ›´å¤šï¼Œä¹Ÿè¦çœ‹å¾—å¼€ä¸€ç‚¹ï¼Œæ²¡æ³•äº‹äº‹å¦‚æ„¿ï¼Œå°½åŠ›å°±å¥½äº†ï¼Œå‡è‚¥è¿™ä¸ªäº‹æƒ…è¿˜åœ¨ç»“åˆä¸€äº›ä¿¯å§æ’‘å•¥çš„ï¼Œå¸Œæœ›ä¹Ÿèƒ½åšæŒä¸‹å»ï¼ŒåŠ æ²¹å§ï¼Œä¸çŸ¥é“åŸè¯æ€ä¹ˆè¯´çš„ï¼Œæ„æ€æ˜¯äººç±»æœ€å¤§çš„å‹‡æ•¢å°±æ˜¯çœ‹é€äº†äººä¸–é—´çš„è‹¦éš¾ï¼Œä»ç„¶çƒ­çˆ±ç”Ÿæ´»ã€‚æˆ‘å½“ç„¶æ²¡å¯èƒ½è®©å†…å¿ƒå˜å¾—è¿™ä¹ˆå¼ºå¤§ï¼Œè¯•ç€å»åŠªåŠ›å§ï¼Œå¥¥åŠ›ç»™ï¼</p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://nicksxs.me/2020/07/05/%E8%81%8A%E4%B8%80%E4%B8%8B-RocketMQ-%E7%9A%84-NameServer-%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="Nicksxs">
      <meta itemprop="description" content="learn from zero,æŠ€æœ¯åšå®¢ï¼ŒNicksxsï¼Œå²å­¦æ£®">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nicksxs's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/05/%E8%81%8A%E4%B8%80%E4%B8%8B-RocketMQ-%E7%9A%84-NameServer-%E6%BA%90%E7%A0%81/" class="post-title-link" itemprop="url">èŠä¸€ä¸‹ RocketMQ çš„ NameServer æºç </a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-05 21:01:47" itemprop="dateCreated datePublished" datetime="2020-07-05T21:01:47+08:00">2020-07-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ¶ˆæ¯é˜Ÿåˆ—</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">ä¸­é—´ä»¶</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
            </span>

          
            <span id="/2020/07/05/%E8%81%8A%E4%B8%80%E4%B8%8B-RocketMQ-%E7%9A%84-NameServer-%E6%BA%90%E7%A0%81/" class="post-meta-item leancloud_visitors" data-flag-title="èŠä¸€ä¸‹ RocketMQ çš„ NameServer æºç " title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/07/05/%E8%81%8A%E4%B8%80%E4%B8%8B-RocketMQ-%E7%9A%84-NameServer-%E6%BA%90%E7%A0%81/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/07/05/èŠä¸€ä¸‹-RocketMQ-çš„-NameServer-æºç /" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>å‰é¢ä»‹ç»äº†ï¼Œnameserverç›¸å½“äºdubboçš„æ³¨å†Œä¸­å¿ƒï¼Œç”¨ä¸ç®¡ç†brokerï¼Œbrokerä¼šåœ¨å¯åŠ¨çš„æ—¶å€™æ³¨å†Œåˆ°nameserverï¼Œå¹¶ä¸”ä¼šå‘é€å¿ƒè·³ç»™namaserverï¼Œnameserverè´Ÿè´£ä¿å­˜æ´»è·ƒçš„brokerï¼ŒåŒ…æ‹¬masterå’Œslaveï¼ŒåŒæ—¶ä¿å­˜topicå’Œtopicä¸‹çš„é˜Ÿåˆ—ï¼Œä»¥åŠfilteråˆ—è¡¨ï¼Œç„¶åä¸ºproducerå’Œconsumerçš„è¯·æ±‚æä¾›æœåŠ¡ã€‚</p>
<h3 id="å¯åŠ¨è¿‡ç¨‹"><a href="#å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="å¯åŠ¨è¿‡ç¨‹"></a>å¯åŠ¨è¿‡ç¨‹</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">main0</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">NamesrvController</span> <span class="token function">main0</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">NamesrvController</span> controller <span class="token operator">=</span> <span class="token function">createNamesrvController</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">start</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> tip <span class="token operator">=</span> <span class="token string">"The Name Server boot success. serializeType="</span> <span class="token operator">+</span> <span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span><span class="token function">getSerializeTypeConfigInThisServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>tip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> tip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> controller<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…¥å£çš„ä»£ç æ—¶è¿™æ ·å­ï¼Œå…¶å®ä¸»è¦çš„é€»è¾‘åœ¨createNamesrvControllerå’Œstartæ–¹æ³•ï¼Œæ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªçš„å®ç°</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">NamesrvController</span> <span class="token function">createNamesrvController</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">JoranException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span>REMOTING_VERSION_KEY<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">MQVersion</span><span class="token punctuation">.</span>CURRENT_VERSION<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//PackageConflictDetect.detectFastjson();</span>

        <span class="token class-name">Options</span> options <span class="token operator">=</span> <span class="token class-name">ServerUtil</span><span class="token punctuation">.</span><span class="token function">buildCommandlineOptions</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        commandLine <span class="token operator">=</span> <span class="token class-name">ServerUtil</span><span class="token punctuation">.</span><span class="token function">parseCmdLine</span><span class="token punctuation">(</span><span class="token string">"mqnamesrv"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token function">buildCommandlineOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PosixParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> commandLine<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">final</span> <span class="token class-name">NamesrvConfig</span> namesrvConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamesrvConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">NettyServerConfig</span> nettyServerConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nettyServerConfig<span class="token punctuation">.</span><span class="token function">setListenPort</span><span class="token punctuation">(</span><span class="token number">9876</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>commandLine<span class="token punctuation">.</span><span class="token function">hasOption</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> file <span class="token operator">=</span> commandLine<span class="token punctuation">.</span><span class="token function">getOptionValue</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                properties<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token function">properties2Object</span><span class="token punctuation">(</span>properties<span class="token punctuation">,</span> namesrvConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token function">properties2Object</span><span class="token punctuation">(</span>properties<span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

                namesrvConfig<span class="token punctuation">.</span><span class="token function">setConfigStorePath</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"load config properties file OK, %s%n"</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>commandLine<span class="token punctuation">.</span><span class="token function">hasOption</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">InternalLogger</span> console <span class="token operator">=</span> <span class="token class-name">InternalLoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LoggerName</span><span class="token punctuation">.</span>NAMESRV_CONSOLE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token function">printObjectProperties</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> namesrvConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token function">printObjectProperties</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token function">properties2Object</span><span class="token punctuation">(</span><span class="token class-name">ServerUtil</span><span class="token punctuation">.</span><span class="token function">commandLine2Properties</span><span class="token punctuation">(</span>commandLine<span class="token punctuation">)</span><span class="token punctuation">,</span> namesrvConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> namesrvConfig<span class="token punctuation">.</span><span class="token function">getRocketmqHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please set the %s variable in your environment to match the location of the RocketMQ installation%n"</span><span class="token punctuation">,</span> <span class="token class-name">MixAll</span><span class="token punctuation">.</span>ROCKETMQ_HOME_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">LoggerContext</span> lc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LoggerContext</span><span class="token punctuation">)</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getILoggerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JoranConfigurator</span> configurator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JoranConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configurator<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lc<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configurator<span class="token punctuation">.</span><span class="token function">doConfigure</span><span class="token punctuation">(</span>namesrvConfig<span class="token punctuation">.</span><span class="token function">getRocketmqHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/conf/logback_namesrv.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log <span class="token operator">=</span> <span class="token class-name">InternalLoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LoggerName</span><span class="token punctuation">.</span>NAMESRV_LOGGER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token function">printObjectProperties</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> namesrvConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token function">printObjectProperties</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">NamesrvController</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamesrvController</span><span class="token punctuation">(</span>namesrvConfig<span class="token punctuation">,</span> nettyServerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// remember all configs to prevent discard</span>
        controller<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerConfig</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> controller<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™ä¸ªæ–¹æ³•é‡Œå…¶å®ä¸»è¦æ˜¯è¯»å–ä¸€äº›é…ç½®å•¥çš„ï¼Œä¸æ˜¯å¾ˆå¤æ‚ï¼Œ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">NamesrvController</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">NamesrvController</span> controller<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> controller<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"NamesrvController is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">boolean</span> initResult <span class="token operator">=</span> controller<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            controller<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ShutdownHookThread</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
                controller<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        controller<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> controller<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™ä¸ªstarté‡Œä¸»è¦å…³æ³¨initializeæ–¹æ³•ï¼Œåé¢å°±æ˜¯ä¸€ä¸ªåœæœºçš„hookï¼Œæ¥çœ‹ä¸‹initializeæ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>kvConfigManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyRemotingServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nettyServerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerHousekeepingService<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingExecutor <span class="token operator">=</span>
            <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">getServerWorkerThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"RemotingExecutorThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">NamesrvController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>routeInfoManager<span class="token punctuation">.</span><span class="token function">scanNotActiveBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">NamesrvController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>kvConfigManager<span class="token punctuation">.</span><span class="token function">printAllPeriodically</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsMode <span class="token operator">!=</span> <span class="token class-name">TlsMode</span><span class="token punctuation">.</span>DISABLED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Register a listener to reload SslContext</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                fileWatchService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWatchService</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerCertPath<span class="token punctuation">,</span>
                        <span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerKeyPath<span class="token punctuation">,</span>
                        <span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerTrustCertPath
                    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">FileWatchService<span class="token punctuation">.</span>Listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">boolean</span> certChanged<span class="token punctuation">,</span> keyChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onChanged</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerTrustCertPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"The trust certificate changed, reload the ssl context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">reloadServerSslContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerCertPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                certChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">TlsSystemConfig</span><span class="token punctuation">.</span>tlsServerKeyPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                keyChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>certChanged <span class="token operator">&amp;&amp;</span> keyChanged<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"The certificate and private key changed, reload the ssl context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                certChanged <span class="token operator">=</span> keyChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                                <span class="token function">reloadServerSslContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reloadServerSslContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NettyRemotingServer</span><span class="token punctuation">)</span> remotingServer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadSslContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"FileWatchService created error, can't load the certificate dynamically"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œçš„kvConfigManagerä¸»è¦æ˜¯æ¥åŠ è½½NameServerçš„é…ç½®å‚æ•°ï¼Œå­˜åˆ°org.apache.rocketmq.namesrv.kvconfig.KVConfigManager#configTableä¸­ï¼Œç„¶åæ˜¯ä»¥BrokerHousekeepingServiceå¯¹è±¡ä¸ºå‚æ•°åˆå§‹åŒ–NettyRemotingServerå¯¹è±¡ï¼ŒBrokerHousekeepingServiceå¯¹è±¡ä½œä¸ºè¯¥Nettyè¿æ¥ä¸­Socketé“¾æ¥çš„ç›‘å¬å™¨ï¼ˆChannelEventListenerï¼‰ï¼›ç›‘å¬ä¸Brokerå»ºç«‹çš„æ¸ é“çš„çŠ¶æ€ï¼ˆç©ºé—²ã€å…³é—­ã€å¼‚å¸¸ä¸‰ä¸ªçŠ¶æ€ï¼‰ï¼Œå¹¶è°ƒç”¨BrokerHousekeepingServiceçš„ç›¸åº”onChannelæ–¹æ³•ã€‚å…¶ä¸­æ¸ é“çš„ç©ºé—²ã€å…³é—­ã€å¼‚å¸¸çŠ¶æ€å‡è°ƒç”¨RouteInfoManager.onChannelDestoryæ–¹æ³•å¤„ç†ã€‚è¿™ä¸ªBrokerHousekeepingServiceå¯ä»¥å­—é¢åŒ–åœ°ç†è§£ä¸ºbrokerçš„ç®¡å®¶æœåŠ¡ï¼Œè¿™ä¸ªç±»å†…éƒ¨ä¸‰ä¸ªçŠ¶æ€æ–¹æ³•å…¶å®éƒ½æ˜¯è°ƒç”¨çš„org.apache.rocketmq.namesrv.NamesrvController#getRouteInfoManageræ–¹æ³•ï¼Œè€Œè¿™ä¸ªRouteInfoManageré‡Œé¢çš„å¯¹è±¡æœ‰è¿™äº›</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RouteInfoManager</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">InternalLogger</span> log <span class="token operator">=</span> <span class="token class-name">InternalLoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LoggerName</span><span class="token punctuation">.</span>NAMESRV_LOGGER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> BROKER_CHANNEL_EXPIRED_TIME <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReadWriteLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// topicä¸queueçš„å¯¹åº”å…³ç³»</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* topic */</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueueData</span><span class="token punctuation">></span></span><span class="token operator">></span> topicQueueTable<span class="token punctuation">;</span>
  <span class="token comment">// Brokeråç§°ä¸brokerå±æ€§çš„map</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* brokerName */</span><span class="token punctuation">,</span> <span class="token class-name">BrokerData</span><span class="token operator">></span> brokerAddrTable<span class="token punctuation">;</span>
  <span class="token comment">// é›†ç¾¤ä¸brokeré›†åˆçš„å¯¹åº”å…³ç³»</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* clusterName */</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* brokerName */</span><span class="token operator">>></span> clusterAddrTable<span class="token punctuation">;</span>
  <span class="token comment">// æ´»è·ƒçš„brokerä¿¡æ¯</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* brokerAddr */</span><span class="token punctuation">,</span> <span class="token class-name">BrokerLiveInfo</span><span class="token operator">></span> brokerLiveTable<span class="token punctuation">;</span>
  <span class="token comment">// Brokeråœ°å€ä¸è¿‡æ»¤å™¨</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* brokerAddr */</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token comment">/* Filter Server */</span><span class="token operator">></span> filterServerTable<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åæ¥ä¸‹å»å°±æ˜¯åˆå§‹åŒ–äº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œç„¶åæ³¨å†Œé»˜è®¤çš„å¤„ç†ç±»<code>this.registerProcessor();</code>é»˜è®¤éƒ½æ˜¯è¿™ä¸ªå¤„ç†å™¨å»å¤„ç†è¯·æ±‚ <code>org.apache.rocketmq.namesrv.processor.DefaultRequestProcessor#DefaultRequestProcessor</code>ç„¶åæ˜¯åˆå§‹åŒ–ä¸¤ä¸ªå®šæ—¶ä»»åŠ¡</p>
<p>ç¬¬ä¸€æ˜¯æ¯10ç§’æ£€æŸ¥ä¸€éBrokerçš„çŠ¶æ€çš„å®šæ—¶ä»»åŠ¡ï¼Œè°ƒç”¨scanNotActiveBrokeræ–¹æ³•ï¼›éå†brokerLiveTableé›†åˆï¼ŒæŸ¥çœ‹æ¯ä¸ªbrokerçš„æœ€åæ›´æ–°æ—¶é—´ï¼ˆBrokerLiveInfo.lastUpdateTimestampï¼‰æ˜¯å¦è¶…è¿‡2åˆ†é’Ÿï¼Œè‹¥è¶…è¿‡åˆ™å…³é—­è¯¥brokerçš„æ¸ é“å¹¶è°ƒç”¨RouteInfoManager.onChannelDestoryæ–¹æ³•æ¸…ç†RouteInfoManagerç±»çš„topicQueueTableã€brokerAddrTableã€clusterAddrTableã€filterServerTableæˆå‘˜å˜é‡ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">NamesrvController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>routeInfoManager<span class="token punctuation">.</span><span class="token function">scanNotActiveBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scanNotActiveBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BrokerLiveInfo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerLiveTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BrokerLiveInfo</span><span class="token punctuation">></span></span> next <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> last <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastUpdateTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>last <span class="token operator">+</span> BROKER_CHANNEL_EXPIRED_TIME<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">RemotingUtil</span><span class="token punctuation">.</span><span class="token function">closeChannel</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"The broker channel expired, &#123;&#125; &#123;&#125;ms"</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BROKER_CHANNEL_EXPIRED_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChannelDestroy</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onChannelDestroy</span><span class="token punctuation">(</span><span class="token class-name">String</span> remoteAddr<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> brokerAddrFound <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BrokerLiveInfo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> itBrokerLiveTable <span class="token operator">=</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerLiveTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>itBrokerLiveTable<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BrokerLiveInfo</span><span class="token punctuation">></span></span> entry <span class="token operator">=</span> itBrokerLiveTable<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            brokerAddrFound <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"onChannelDestroy Exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> brokerAddrFound<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            brokerAddrFound <span class="token operator">=</span> remoteAddr<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"the broker's channel destroyed, &#123;&#125;, clean it's data structure at once"</span><span class="token punctuation">,</span> brokerAddrFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerAddrFound <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> brokerAddrFound<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerLiveTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>brokerAddrFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>filterServerTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>brokerAddrFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> brokerNameFound <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> removeBrokerName <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BrokerData</span><span class="token punctuation">></span><span class="token punctuation">></span></span> itBrokerAddrTable <span class="token operator">=</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerAddrTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>itBrokerAddrTable<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> brokerNameFound<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">BrokerData</span> brokerData <span class="token operator">=</span> itBrokerAddrTable<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> it <span class="token operator">=</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> entry <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">Long</span> brokerId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">String</span> brokerAddr <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerAddr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>brokerAddrFound<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                brokerNameFound <span class="token operator">=</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"remove brokerAddr[&#123;&#125;, &#123;&#125;] from brokerAddrTable, because channel destroyed"</span><span class="token punctuation">,</span>
                                    brokerId<span class="token punctuation">,</span> brokerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            removeBrokerName <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            itBrokerAddrTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"remove brokerName[&#123;&#125;] from brokerAddrTable, because channel destroyed"</span><span class="token punctuation">,</span>
                                brokerData<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerNameFound <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> removeBrokerName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span> it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clusterAddrTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> entry <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">String</span> clusterName <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> brokerNames <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">boolean</span> removed <span class="token operator">=</span> brokerNames<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>brokerNameFound<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>removed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"remove brokerName[&#123;&#125;], clusterName[&#123;&#125;] from clusterAddrTable, because channel destroyed"</span><span class="token punctuation">,</span>
                                    brokerNameFound<span class="token punctuation">,</span> clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerNames<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"remove the clusterName[&#123;&#125;] from clusterAddrTable, because channel destroyed and no broker in this cluster"</span><span class="token punctuation">,</span>
                                        clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>

                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>removeBrokerName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">QueueData</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span> itTopicQueueTable <span class="token operator">=</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>topicQueueTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>itTopicQueueTable<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">QueueData</span><span class="token punctuation">></span><span class="token punctuation">></span></span> entry <span class="token operator">=</span> itTopicQueueTable<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">String</span> topic <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueueData</span><span class="token punctuation">></span></span> queueDataList <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueueData</span><span class="token punctuation">></span></span> itQueueData <span class="token operator">=</span> queueDataList<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">while</span> <span class="token punctuation">(</span>itQueueData<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token class-name">QueueData</span> queueData <span class="token operator">=</span> itQueueData<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>queueData<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>brokerNameFound<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    itQueueData<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"remove topic[&#123;&#125; &#123;&#125;], from topicQueueTable, because channel destroyed"</span><span class="token punctuation">,</span>
                                        topic<span class="token punctuation">,</span> queueData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">&#125;</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span>queueDataList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                itTopicQueueTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"remove topic[&#123;&#125;] all queue, from topicQueueTable, because channel destroyed"</span><span class="token punctuation">,</span>
                                    topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"onChannelDestroy Exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¬¬äºŒä¸ªæ˜¯æ¯10åˆ†é’Ÿæ‰“å°ä¸€æ¬¡NameServerçš„é…ç½®å‚æ•°ã€‚å³KVConfigManager.configTableå˜é‡çš„å†…å®¹ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">NamesrvController</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>kvConfigManager<span class="token punctuation">.</span><span class="token function">printAllPeriodically</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åè¿™ä¸ªåˆå§‹åŒ–å°±å·®ä¸å¤šå®Œæˆäº†ï¼Œåé¢åªéœ€è¦æŠŠremotingServer startä¸€ä¸‹å°±å¥½äº†</p>
<h3 id="å¤„ç†è¯·æ±‚"><a href="#å¤„ç†è¯·æ±‚" class="headerlink" title="å¤„ç†è¯·æ±‚"></a>å¤„ç†è¯·æ±‚</h3><p>ç›´æ¥ä¸Šä»£ç ï¼Œå…¶å®ä¸»ä½“æ˜¯swtich caseå»åˆ¤æ–­</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
        <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"receive request, &#123;&#125; &#123;&#125; &#123;&#125;"</span><span class="token punctuation">,</span>
                request<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token function">parseChannelRemoteAddr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>


        <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>PUT_KV_CONFIG<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putKVConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_KV_CONFIG<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKVConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>DELETE_KV_CONFIG<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deleteKVConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>QUERY_DATA_VERSION<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">queryBrokerTopicConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>REGISTER_BROKER<span class="token operator">:</span>
                <span class="token class-name">Version</span> brokerVersion <span class="token operator">=</span> <span class="token class-name">MQVersion</span><span class="token punctuation">.</span><span class="token function">value2Version</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerVersion<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token class-name">MQVersion<span class="token punctuation">.</span>Version</span><span class="token punctuation">.</span>V3_0_11<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBrokerWithFilterServer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBroker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>UNREGISTER_BROKER<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unregisterBroker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_ROUTEINTO_BY_TOPIC<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRouteInfoByTopic</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_BROKER_CLUSTER_INFO<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBrokerClusterInfo</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>WIPE_WRITE_PERM_OF_BROKER<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wipeWritePermOfBroker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_ALL_TOPIC_LIST_FROM_NAMESERVER<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">getAllTopicListFromNameserver</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>DELETE_TOPIC_IN_NAMESRV<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">deleteTopicInNamesrv</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_KVLIST_BY_NAMESPACE<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKVListByNamespace</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_TOPICS_BY_CLUSTER<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTopicsByCluster</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_SYSTEM_TOPIC_LIST_FROM_NS<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSystemTopicListFromNs</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_UNIT_TOPIC_LIST<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUnitTopicList</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_HAS_UNIT_SUB_TOPIC_LIST<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHasUnitSubTopicList</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHasUnitSubUnUnitTopicList</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>UPDATE_NAMESRV_CONFIG<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>GET_NAMESRV_CONFIG<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»¥brokeræ³¨å†Œä¸ºä¾‹ï¼Œ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span>REGISTER_BROKER<span class="token operator">:</span>
                <span class="token class-name">Version</span> brokerVersion <span class="token operator">=</span> <span class="token class-name">MQVersion</span><span class="token punctuation">.</span><span class="token function">value2Version</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerVersion<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token class-name">MQVersion<span class="token punctuation">.</span>Version</span><span class="token punctuation">.</span>V3_0_11<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBrokerWithFilterServer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBroker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åšäº†ä¸ªç®€å•çš„ç‰ˆæœ¬ç®¡ç†ï¼Œæˆ‘ä»¬çœ‹ä¸‹å‰é¢ä¸€ä¸ªçš„ä»£ç </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">registerBrokerWithFilterServer</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">final</span> <span class="token class-name">RemotingCommand</span> response <span class="token operator">=</span> <span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span><span class="token function">createResponseCommand</span><span class="token punctuation">(</span><span class="token class-name">RegisterBrokerResponseHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">RegisterBrokerResponseHeader</span> responseHeader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RegisterBrokerResponseHeader</span><span class="token punctuation">)</span> response<span class="token punctuation">.</span><span class="token function">readCustomHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">RegisterBrokerRequestHeader</span> requestHeader <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token class-name">RegisterBrokerRequestHeader</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">RegisterBrokerRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checksum</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span>SYSTEM_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">"crc32 not match"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">RegisterBrokerBody</span> registerBrokerBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegisterBrokerBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            registerBrokerBody <span class="token operator">=</span> <span class="token class-name">RegisterBrokerBody</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">isCompressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemotingCommandException</span><span class="token punctuation">(</span><span class="token string">"Failed to decode RegisterBrokerBody"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        registerBrokerBody<span class="token punctuation">.</span><span class="token function">getTopicConfigSerializeWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDataVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCounter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registerBrokerBody<span class="token punctuation">.</span><span class="token function">getTopicConfigSerializeWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDataVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">RegisterBrokerResult</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getRouteInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerBroker</span><span class="token punctuation">(</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">getBrokerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">getBrokerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">getHaServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        registerBrokerBody<span class="token punctuation">.</span><span class="token function">getTopicConfigSerializeWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        registerBrokerBody<span class="token punctuation">.</span><span class="token function">getFilterServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    responseHeader<span class="token punctuation">.</span><span class="token function">setHaServerAddr</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getHaServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setMasterAddr</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getMasterAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> jsonValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getKvConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKVListByNamespace</span><span class="token punctuation">(</span><span class="token class-name">NamesrvUtil</span><span class="token punctuation">.</span>NAMESPACE_ORDER_TOPIC_CONFIG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>jsonValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

    response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯ä»¥çœ‹åˆ°ä¸»è¦çš„é€»è¾‘è¿˜æ˜¯åœ¨<code>org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager#registerBroker</code>è¿™ä¸ªæ–¹æ³•é‡Œ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">RegisterBrokerResult</span> <span class="token function">registerBroker</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> clusterName<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> brokerAddr<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> brokerName<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> brokerId<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> haServerAddr<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">TopicConfigSerializeWrapper</span> topicConfigWrapper<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> filterServerList<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">RegisterBrokerResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegisterBrokerResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// æ›´æ–°è¿™ä¸ªclusterAddrTable</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> brokerNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clusterAddrTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> brokerNames<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    brokerNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>clusterAddrTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">,</span> brokerNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                brokerNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">boolean</span> registerFirst <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

              <span class="token comment">// æ›´æ–°brokerAddrTable</span>
                <span class="token class-name">BrokerData</span> brokerData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerAddrTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> brokerData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    registerFirst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    brokerData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerData</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">,</span> brokerName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerAddrTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">,</span> brokerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> brokerAddrsMap <span class="token operator">=</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//Switch slave to master: first remove &lt;1, IP:PORT> in namesrv, then add &lt;0, IP:PORT></span>
                <span class="token comment">//The same IP:PORT must only have one record in brokerAddrTable</span>
                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> it <span class="token operator">=</span> brokerAddrsMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> item <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> brokerAddr <span class="token operator">&amp;&amp;</span> brokerAddr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> brokerId <span class="token operator">!=</span> item<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token class-name">String</span> oldAddr <span class="token operator">=</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>brokerId<span class="token punctuation">,</span> brokerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                registerFirst <span class="token operator">=</span> registerFirst <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> oldAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// æ›´æ–°äº†org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager#topicQueueTableä¸­çš„æ•°æ®</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> topicConfigWrapper
                    <span class="token operator">&amp;&amp;</span> <span class="token class-name">MixAll</span><span class="token punctuation">.</span>MASTER_ID <span class="token operator">==</span> brokerId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBrokerTopicConfigChanged</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> topicConfigWrapper<span class="token punctuation">.</span><span class="token function">getDataVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">||</span> registerFirst<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TopicConfig</span><span class="token punctuation">></span></span> tcTable <span class="token operator">=</span>
                            topicConfigWrapper<span class="token punctuation">.</span><span class="token function">getTopicConfigTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>tcTable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TopicConfig</span><span class="token punctuation">></span></span> entry <span class="token operator">:</span> tcTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createAndUpdateQueueData</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>

              <span class="token comment">// æ›´æ–°æ´»è·ƒbrokerä¿¡æ¯</span>
                <span class="token class-name">BrokerLiveInfo</span> prevBrokerLiveInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerLiveTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">BrokerLiveInfo</span><span class="token punctuation">(</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        topicConfigWrapper<span class="token punctuation">.</span><span class="token function">getDataVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        channel<span class="token punctuation">,</span>
                        haServerAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> prevBrokerLiveInfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"new broker registered, &#123;&#125; HAServer: &#123;&#125;"</span><span class="token punctuation">,</span> brokerAddr<span class="token punctuation">,</span> haServerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

              <span class="token comment">// å¤„ç†filter</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>filterServerList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>filterServerList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>filterServerTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>filterServerTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> filterServerList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>

              <span class="token comment">// å½“å½“å‰brokerémasteræ—¶è¿”å›masterä¿¡æ¯</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span>MASTER_ID <span class="token operator">!=</span> brokerId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">String</span> masterAddr <span class="token operator">=</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span>MASTER_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>masterAddr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">BrokerLiveInfo</span> brokerLiveInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerLiveTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>masterAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerLiveInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            result<span class="token punctuation">.</span><span class="token function">setHaServerAddr</span><span class="token punctuation">(</span>brokerLiveInfo<span class="token punctuation">.</span><span class="token function">getHaServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            result<span class="token punctuation">.</span><span class="token function">setMasterAddr</span><span class="token punctuation">(</span>masterAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"registerBroker Exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™ä¸ªæ˜¯æ³¨å†Œ broker çš„é€»è¾‘ï¼Œå†çœ‹ä¸‹æ ¹æ® topic è·å– broker ä¿¡æ¯å’Œ topic ä¿¡æ¯ï¼Œ<code>org.apache.rocketmq.namesrv.processor.DefaultRequestProcessor#getRouteInfoByTopic</code> ä¸»è¦æ˜¯è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">getRouteInfoByTopic</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
        <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">RemotingCommand</span> response <span class="token operator">=</span> <span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span><span class="token function">createResponseCommand</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">GetRouteInfoRequestHeader</span> requestHeader <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">GetRouteInfoRequestHeader</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">GetRouteInfoRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TopicRouteData</span> topicRouteData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getRouteInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pickupTopicRouteData</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>topicRouteData <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getNamesrvConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOrderMessageEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">String</span> orderTopicConf <span class="token operator">=</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getKvConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKVConfig</span><span class="token punctuation">(</span><span class="token class-name">NamesrvUtil</span><span class="token punctuation">.</span>NAMESPACE_ORDER_TOPIC_CONFIG<span class="token punctuation">,</span>
                        requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                topicRouteData<span class="token punctuation">.</span><span class="token function">setOrderTopicConf</span><span class="token punctuation">(</span>orderTopicConf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content <span class="token operator">=</span> topicRouteData<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span>TOPIC_NOT_EXIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">"No topic route info in name server for the topic: "</span> <span class="token operator">+</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token class-name">FAQUrl</span><span class="token punctuation">.</span><span class="token function">suggestTodo</span><span class="token punctuation">(</span><span class="token class-name">FAQUrl</span><span class="token punctuation">.</span>APPLY_TOPIC_URL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é¦–å…ˆè°ƒç”¨<code>org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager#pickupTopicRouteData</code>ä»<code>org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager#topicQueueTable</code>è·å–åˆ°<code>org.apache.rocketmq.common.protocol.route.QueueData</code>è¿™é‡Œé¢å­˜äº† brokerNameï¼Œå†é€šè¿‡<code>org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager#brokerAddrTable</code>é‡Œè·å–åˆ° broker çš„åœ°å€ä¿¡æ¯ç­‰ï¼Œç„¶åå†è·å– orderMessage çš„é…ç½®ã€‚</p>
<p>ç®€è¦åˆ†æäº†ä¸‹ RocketMQ çš„ NameServer çš„ä»£ç ï¼Œæ¯”è¾ƒç²—ç²’åº¦ã€‚</p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://nicksxs.me/2020/06/26/%E8%81%8A%E4%B8%80%E4%B8%8B-RocketMQ-%E7%9A%84-Consumer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="Nicksxs">
      <meta itemprop="description" content="learn from zero,æŠ€æœ¯åšå®¢ï¼ŒNicksxsï¼Œå²å­¦æ£®">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nicksxs's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/26/%E8%81%8A%E4%B8%80%E4%B8%8B-RocketMQ-%E7%9A%84-Consumer/" class="post-title-link" itemprop="url">èŠä¸€ä¸‹ RocketMQ çš„ DefaultMQPushConsumer æºç </a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-26 22:21:20" itemprop="dateCreated datePublished" datetime="2020-06-26T22:21:20+08:00">2020-06-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ¶ˆæ¯é˜Ÿåˆ—</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">ä¸­é—´ä»¶</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
            </span>

          
            <span id="/2020/06/26/%E8%81%8A%E4%B8%80%E4%B8%8B-RocketMQ-%E7%9A%84-Consumer/" class="post-meta-item leancloud_visitors" data-flag-title="èŠä¸€ä¸‹ RocketMQ çš„ DefaultMQPushConsumer æºç " title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/06/26/%E8%81%8A%E4%B8%80%E4%B8%8B-RocketMQ-%E7%9A%84-Consumer/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/06/26/èŠä¸€ä¸‹-RocketMQ-çš„-Consumer/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>é¦–å…ˆçœ‹ä¸‹å®˜æ–¹çš„å° demo</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public static void main(String[] args) throws InterruptedException, MQClientException &#123;

        &#x2F;*
         * Instantiate with specified consumer group name.
         * é¦–å…ˆæ˜¯new ä¸€ä¸ªå¯¹è±¡å‡ºæ¥ï¼Œç„¶åæŒ‡å®š Consumer çš„ Group
         * åŒä¸€ç±»Consumerçš„é›†åˆï¼Œè¿™ç±»Consumeré€šå¸¸æ¶ˆè´¹åŒä¸€ç±»æ¶ˆæ¯ä¸”æ¶ˆè´¹é€»è¾‘ä¸€è‡´ã€‚æ¶ˆè´¹è€…ç»„ä½¿å¾—åœ¨æ¶ˆæ¯æ¶ˆè´¹æ–¹é¢ï¼Œå®ç°è´Ÿè½½å‡è¡¡å’Œå®¹é”™çš„ç›®æ ‡å˜å¾—éå¸¸å®¹æ˜“ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹è€…å®ä¾‹å¿…é¡»è®¢é˜…å®Œå…¨ç›¸åŒçš„Topicã€‚RocketMQ æ”¯æŒä¸¤ç§æ¶ˆæ¯æ¨¡å¼ï¼šé›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰å’Œå¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰ã€‚
         *&#x2F;
        DefaultMQPushConsumer consumer &#x3D; new DefaultMQPushConsumer(&quot;please_rename_unique_group_name_4&quot;);

        &#x2F;*
         * Specify name server addresses.
         * &lt;p&#x2F;&gt;
         * è¿™é‡Œå¯ä»¥é€šçŸ¥æŒ‡å®šç¯å¢ƒå˜é‡æˆ–è€…è®¾ç½®å¯¹è±¡å‚æ•°çš„å½¢å¼æŒ‡å®šåå­—ç©ºé—´æœåŠ¡çš„åœ°å€
         *
         * Alternatively, you may specify name server addresses via exporting environmental variable: NAMESRV_ADDR
         * &lt;pre&gt;
         * &#123;@code
         * consumer.setNamesrvAddr(&quot;name-server1-ip:9876;name-server2-ip:9876&quot;);
         * &#125;
         * &lt;&#x2F;pre&gt;
         *&#x2F;

        &#x2F;*
         * Specify where to start in case the specified consumer group is a brand new one.
         * æŒ‡å®šæ¶ˆè´¹èµ·å§‹ç‚¹
         *&#x2F;
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);

        &#x2F;*
         * Subscribe one more more topics to consume.
         * æŒ‡å®šè®¢é˜…çš„ topic è·Ÿ tagï¼Œæ³¨æ„åé¢çš„æ˜¯ä¸ªè¡¨è¾¾å¼ï¼Œå¯ä»¥ä»¥ tag1 || tag2 || tag3 ä¼ å…¥
         *&#x2F;
        consumer.subscribe(&quot;TopicTest&quot;, &quot;*&quot;);

        &#x2F;*
         *  Register callback to execute on arrival of messages fetched from brokers.
         *  æ³¨å†Œå…·ä½“è·å¾—æ¶ˆæ¯åçš„å¤„ç†æ–¹æ³•
         *&#x2F;
        consumer.registerMessageListener(new MessageListenerConcurrently() &#123;

            @Override
            public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs,
                ConsumeConcurrentlyContext context) &#123;
                System.out.printf(&quot;%s Receive New Messages: %s %n&quot;, Thread.currentThread().getName(), msgs);
                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
            &#125;
        &#125;);

        &#x2F;*
         *  Launch the consumer instance.
         * å¯åŠ¨æ¶ˆè´¹è€…
         *&#x2F;
        consumer.start();

        System.out.printf(&quot;Consumer Started.%n&quot;);
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åå°±æ˜¯çœ‹çœ‹ start çš„è¿‡ç¨‹äº†</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">&#x2F;**
     * This method gets internal infrastructure readily to serve. Instances must call this method after configuration.
     *
     * @throws MQClientException if there is any client error.
     *&#x2F;
    @Override
    public void start() throws MQClientException &#123;
        setConsumerGroup(NamespaceUtil.wrapNamespace(this.getNamespace(), this.consumerGroup));
        this.defaultMQPushConsumerImpl.start();
        if (null !&#x3D; traceDispatcher) &#123;
            try &#123;
                traceDispatcher.start(this.getNamesrvAddr(), this.getAccessChannel());
            &#125; catch (MQClientException e) &#123;
                log.warn(&quot;trace dispatcher start failed &quot;, e);
            &#125;
        &#125;
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å…·ä½“çš„é€»è¾‘åœ¨<code>this.defaultMQPushConsumerImpl.start()</code>ï¼Œè¿™ä¸ª defaultMQPushConsumerImpl å°±æ˜¯</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">&#x2F;**
     * Internal implementation. Most of the functions herein are delegated to it.
     *&#x2F;
    protected final transient DefaultMQPushConsumerImpl defaultMQPushConsumerImpl;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public synchronized void start() throws MQClientException &#123;
        switch (this.serviceState) &#123;
            case CREATE_JUST:
                log.info(&quot;the consumer [&#123;&#125;] start beginning. messageModel&#x3D;&#123;&#125;, isUnitMode&#x3D;&#123;&#125;&quot;, this.defaultMQPushConsumer.getConsumerGroup(),
                    this.defaultMQPushConsumer.getMessageModel(), this.defaultMQPushConsumer.isUnitMode());
                &#x2F;&#x2F; è¿™é‡Œæ¯”è¾ƒå·§å¦™ï¼Œç›¸å½“äºæƒ³è®¾ç«‹äº†ä¸ªå±éšœï¼Œé˜²æ­¢å¹¶å‘å¯åŠ¨ï¼Œä¸è¿‡è¿™é‡Œå¹¶ä¸æ˜¯æ‚²è§‚é”ï¼Œä¹Ÿä¸ç®—ä¸ªä¸¥æ ¼çš„ä¹è§‚é”
                this.serviceState &#x3D; ServiceState.START_FAILED;

                this.checkConfig();

                this.copySubscription();

                if (this.defaultMQPushConsumer.getMessageModel() &#x3D;&#x3D; MessageModel.CLUSTERING) &#123;
                    this.defaultMQPushConsumer.changeInstanceNameToPID();
                &#125;

                &#x2F;&#x2F; è¿™ä¸ªmQClientFactoryï¼Œè´Ÿè´£ç®¡ç†clientï¼ˆconsumerã€producerï¼‰ï¼Œå¹¶æä¾›å¤šä¸­åŠŸèƒ½æ¥å£ä¾›å„ä¸ªServiceï¼ˆRebalanceã€PullMessageç­‰ï¼‰è°ƒç”¨ï¼›å¤§éƒ¨åˆ†é€»è¾‘å‡åœ¨è¿™ä¸ªç±»ä¸­å®Œæˆ
                this.mQClientFactory &#x3D; MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQPushConsumer, this.rpcHook);

                &#x2F;&#x2F; è¿™ä¸ª rebalanceImpl ä¸»è¦è´Ÿè´£å†³å®šï¼Œå½“å‰çš„consumeråº”è¯¥ä»å“ªäº›Queueä¸­æ¶ˆè´¹æ¶ˆæ¯ï¼›
                this.rebalanceImpl.setConsumerGroup(this.defaultMQPushConsumer.getConsumerGroup());
                this.rebalanceImpl.setMessageModel(this.defaultMQPushConsumer.getMessageModel());
                this.rebalanceImpl.setAllocateMessageQueueStrategy(this.defaultMQPushConsumer.getAllocateMessageQueueStrategy());
                this.rebalanceImpl.setmQClientFactory(this.mQClientFactory);

                &#x2F;&#x2F; é•¿è¿æ¥ï¼Œè´Ÿè´£ä»brokerå¤„æ‹‰å–æ¶ˆæ¯ï¼Œç„¶ååˆ©ç”¨ConsumeMessageServiceå›è°ƒç”¨æˆ·çš„Listeneræ‰§è¡Œæ¶ˆæ¯æ¶ˆè´¹é€»è¾‘
                this.pullAPIWrapper &#x3D; new PullAPIWrapper(
                    mQClientFactory,
                    this.defaultMQPushConsumer.getConsumerGroup(), isUnitMode());
                this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList);

                if (this.defaultMQPushConsumer.getOffsetStore() !&#x3D; null) &#123;
                    this.offsetStore &#x3D; this.defaultMQPushConsumer.getOffsetStore();
                &#125; else &#123;
                    switch (this.defaultMQPushConsumer.getMessageModel()) &#123;
                        case BROADCASTING:
                            this.offsetStore &#x3D; new LocalFileOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());
                            break;
                        case CLUSTERING:
                            this.offsetStore &#x3D; new RemoteBrokerOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());
                            break;
                        default:
                            break;
                    &#125;
                    this.defaultMQPushConsumer.setOffsetStore(this.offsetStore);
                &#125;
                &#x2F;&#x2F; offsetStore ç»´æŠ¤å½“å‰consumerçš„æ¶ˆè´¹è®°å½•ï¼ˆoffsetï¼‰ï¼›æœ‰ä¸¤ç§å®ç°ï¼ŒLocalå’ŒRmoteï¼ŒLocalå­˜å‚¨åœ¨æœ¬åœ°ç£ç›˜ä¸Šï¼Œé€‚ç”¨äºBROADCASTINGå¹¿æ’­æ¶ˆè´¹æ¨¡å¼ï¼›è€ŒRemoteåˆ™å°†æ¶ˆè´¹è¿›åº¦å­˜å‚¨åœ¨Brokerä¸Šï¼Œé€‚ç”¨äºCLUSTERINGé›†ç¾¤æ¶ˆè´¹æ¨¡å¼ï¼›
                this.offsetStore.load();

                if (this.getMessageListenerInner() instanceof MessageListenerOrderly) &#123;
                    this.consumeOrderly &#x3D; true;
                    this.consumeMessageService &#x3D;
                        new ConsumeMessageOrderlyService(this, (MessageListenerOrderly) this.getMessageListenerInner());
                &#125; else if (this.getMessageListenerInner() instanceof MessageListenerConcurrently) &#123;
                    this.consumeOrderly &#x3D; false;
                    this.consumeMessageService &#x3D;
                        new ConsumeMessageConcurrentlyService(this, (MessageListenerConcurrently) this.getMessageListenerInner());
                &#125;

                &#x2F;&#x2F; å®ç°æ‰€è°“çš„&quot;Push-è¢«åŠ¨&quot;æ¶ˆè´¹æœºåˆ¶ï¼›ä»Brokeræ‹‰å–çš„æ¶ˆæ¯åï¼Œå°è£…æˆConsumeRequestæäº¤ç»™ConsumeMessageSerivceï¼Œæ­¤serviceè´Ÿè´£å›è°ƒç”¨æˆ·çš„Listeneræ¶ˆè´¹æ¶ˆæ¯ï¼›
                this.consumeMessageService.start();

                boolean registerOK &#x3D; mQClientFactory.registerConsumer(this.defaultMQPushConsumer.getConsumerGroup(), this);
                if (!registerOK) &#123;
                    this.serviceState &#x3D; ServiceState.CREATE_JUST;
                    this.consumeMessageService.shutdown();
                    throw new MQClientException(&quot;The consumer group[&quot; + this.defaultMQPushConsumer.getConsumerGroup()
                        + &quot;] has been created before, specify another name please.&quot; + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),
                        null);
                &#125;

                mQClientFactory.start();
                log.info(&quot;the consumer [&#123;&#125;] start OK.&quot;, this.defaultMQPushConsumer.getConsumerGroup());
                this.serviceState &#x3D; ServiceState.RUNNING;
                break;
            case RUNNING:
            case START_FAILED:
            case SHUTDOWN_ALREADY:
                throw new MQClientException(&quot;The PushConsumer service state not OK, maybe started once, &quot;
                    + this.serviceState
                    + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),
                    null);
            default:
                break;
        &#125;

        this.updateTopicSubscribeInfoWhenSubscriptionChanged();
        this.mQClientFactory.checkClientInBroker();
        this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();
        this.mQClientFactory.rebalanceImmediately();
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åæˆ‘ä»¬å¾€ä¸‹çœ‹ä¸»è¦çš„ç›®å…‰èšç„¦<code>mQClientFactory.start()</code></p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public void start() throws MQClientException &#123;

        synchronized (this) &#123;
            switch (this.serviceState) &#123;
                case CREATE_JUST:
                    this.serviceState &#x3D; ServiceState.START_FAILED;
                    &#x2F;&#x2F; If not specified,looking address from name server
                    if (null &#x3D;&#x3D; this.clientConfig.getNamesrvAddr()) &#123;
                        this.mQClientAPIImpl.fetchNameServerAddr();
                    &#125;
                    &#x2F;&#x2F; Start request-response channel
                    &#x2F;&#x2F; è¿™é‡Œä¸»è¦æ˜¯åˆå§‹åŒ–äº†ä¸ªç½‘ç»œå®¢æˆ·ç«¯
                    this.mQClientAPIImpl.start();
                    &#x2F;&#x2F; Start various schedule tasks
                    &#x2F;&#x2F; å®šæ—¶ä»»åŠ¡
                    this.startScheduledTask();
                    &#x2F;&#x2F; Start pull service
                    &#x2F;&#x2F; è¿™é‡Œé‡ç‚¹è¯´ä¸‹
                    this.pullMessageService.start();
                    &#x2F;&#x2F; Start rebalance service
                    this.rebalanceService.start();
                    &#x2F;&#x2F; Start push service
                    this.defaultMQProducer.getDefaultMQProducerImpl().start(false);
                    log.info(&quot;the client factory [&#123;&#125;] start OK&quot;, this.clientId);
                    this.serviceState &#x3D; ServiceState.RUNNING;
                    break;
                case START_FAILED:
                    throw new MQClientException(&quot;The Factory object[&quot; + this.getClientId() + &quot;] has been created before, and failed.&quot;, null);
                default:
                    break;
            &#125;
        &#125;
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ª pullMessageServiceï¼Œorg.apache.rocketmq.client.impl.consumer.PullMessageServiceï¼Œ<br><img data-src="https://mystore-1255223546.cos.ap-chengdu.myqcloud.com/uPic/QdeiVv.png"><br>å®ç°äº† runnable æ¥å£ï¼Œ<br>ç„¶åå¯ä»¥çœ‹åˆ° run æ–¹æ³•</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public void run() &#123;
        log.info(this.getServiceName() + &quot; service started&quot;);

        while (!this.isStopped()) &#123;
            try &#123;
                PullRequest pullRequest &#x3D; this.pullRequestQueue.take();
                this.pullMessage(pullRequest);
            &#125; catch (InterruptedException ignored) &#123;
            &#125; catch (Exception e) &#123;
                log.error(&quot;Pull Message Service Run Method exception&quot;, e);
            &#125;
        &#125;

        log.info(this.getServiceName() + &quot; service end&quot;);
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¥ç€åœ¨çœ‹ pullMessage æ–¹æ³•</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">private void pullMessage(final PullRequest pullRequest) &#123;
        final MQConsumerInner consumer &#x3D; this.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());
        if (consumer !&#x3D; null) &#123;
            DefaultMQPushConsumerImpl impl &#x3D; (DefaultMQPushConsumerImpl) consumer;
            impl.pullMessage(pullRequest);
        &#125; else &#123;
            log.warn(&quot;No matched consumer for the PullRequest &#123;&#125;, drop it&quot;, pullRequest);
        &#125;
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å®é™…ä¸Šè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆé•¿ï¼Œæˆ‘åœ¨ä»£ç é‡Œæ³¨é‡Šä¸‹ä¸‹æ¯ä¸€æ®µçš„åŠŸèƒ½</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public void pullMessage(final PullRequest pullRequest) &#123;
        final ProcessQueue processQueue &#x3D; pullRequest.getProcessQueue();
        &#x2F;&#x2F; è¿™é‡Œå¼€å§‹å°±æ˜¯æ£€æŸ¥çŠ¶æ€ï¼Œç¡®å®šæ˜¯å¦å¾€ä¸‹æ‰§è¡Œ
        if (processQueue.isDropped()) &#123;
            log.info(&quot;the pull request[&#123;&#125;] is dropped.&quot;, pullRequest.toString());
            return;
        &#125;

        pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());

        try &#123;
            this.makeSureStateOK();
        &#125; catch (MQClientException e) &#123;
            log.warn(&quot;pullMessage exception, consumer state not ok&quot;, e);
            this.executePullRequestLater(pullRequest, pullTimeDelayMillsWhenException);
            return;
        &#125;

        if (this.isPause()) &#123;
            log.warn(&quot;consumer was paused, execute pull request later. instanceName&#x3D;&#123;&#125;, group&#x3D;&#123;&#125;&quot;, this.defaultMQPushConsumer.getInstanceName(), this.defaultMQPushConsumer.getConsumerGroup());
            this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);
            return;
        &#125;

        &#x2F;&#x2F; è¿™å—å…¶å®æ˜¯ä¸ªç±»ä¼¼äºé™æµçš„åŠŸèƒ½å—ï¼Œå¯¹æ¶ˆæ¯æ•°é‡å’Œæ¶ˆæ¯å¤§å°åšé™åˆ¶
        long cachedMessageCount &#x3D; processQueue.getMsgCount().get();
        long cachedMessageSizeInMiB &#x3D; processQueue.getMsgSize().get() &#x2F; (1024 * 1024);

        if (cachedMessageCount &gt; this.defaultMQPushConsumer.getPullThresholdForQueue()) &#123;
            this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);
            if ((queueFlowControlTimes++ % 1000) &#x3D;&#x3D; 0) &#123;
                log.warn(
                    &quot;the cached message count exceeds the threshold &#123;&#125;, so do flow control, minOffset&#x3D;&#123;&#125;, maxOffset&#x3D;&#123;&#125;, count&#x3D;&#123;&#125;, size&#x3D;&#123;&#125; MiB, pullRequest&#x3D;&#123;&#125;, flowControlTimes&#x3D;&#123;&#125;&quot;,
                    this.defaultMQPushConsumer.getPullThresholdForQueue(), processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), cachedMessageCount, cachedMessageSizeInMiB, pullRequest, queueFlowControlTimes);
            &#125;
            return;
        &#125;

        if (cachedMessageSizeInMiB &gt; this.defaultMQPushConsumer.getPullThresholdSizeForQueue()) &#123;
            this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);
            if ((queueFlowControlTimes++ % 1000) &#x3D;&#x3D; 0) &#123;
                log.warn(
                    &quot;the cached message size exceeds the threshold &#123;&#125; MiB, so do flow control, minOffset&#x3D;&#123;&#125;, maxOffset&#x3D;&#123;&#125;, count&#x3D;&#123;&#125;, size&#x3D;&#123;&#125; MiB, pullRequest&#x3D;&#123;&#125;, flowControlTimes&#x3D;&#123;&#125;&quot;,
                    this.defaultMQPushConsumer.getPullThresholdSizeForQueue(), processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), cachedMessageCount, cachedMessageSizeInMiB, pullRequest, queueFlowControlTimes);
            &#125;
            return;
        &#125;

        &#x2F;&#x2F; è‹¥ä¸æ˜¯é¡ºåºæ¶ˆè´¹ï¼ˆå³DefaultMQPushConsumerImpl.consumeOrderlyç­‰äºfalseï¼‰ï¼Œåˆ™æ£€æŸ¥ProcessQueueå¯¹è±¡çš„msgTreeMap:TreeMap&lt;Long,MessageExt&gt;å˜é‡çš„ç¬¬ä¸€ä¸ªkeyå€¼ä¸æœ€åä¸€ä¸ªkeyå€¼ä¹‹é—´çš„å·®é¢ï¼Œè¯¥keyå€¼è¡¨ç¤ºæŸ¥è¯¢çš„é˜Ÿåˆ—åç§»é‡queueoffsetï¼›è‹¥å·®é¢å¤§äºé˜ˆå€¼ï¼ˆç”±DefaultMQPushConsumer. consumeConcurrentlyMaxSpanæŒ‡å®šï¼Œé»˜è®¤æ˜¯2000ï¼‰ï¼Œåˆ™è°ƒç”¨PullMessageService.executePullRequestLateræ–¹æ³•ï¼Œåœ¨50æ¯«ç§’ä¹‹åé‡æ–°å°†è¯¥PullRequestè¯·æ±‚æ”¾å…¥PullMessageService.pullRequestQueueé˜Ÿåˆ—ä¸­ï¼›å¹¶è·³å‡ºè¯¥æ–¹æ³•ï¼›è¿™é‡Œçš„æ„æ€ä¸»è¦å°±æ˜¯æ¶ˆæ¯æœ‰å †ç§¯äº†ï¼Œç­‰ä¼šå†æ¥æ‹‰å–
        if (!this.consumeOrderly) &#123;
            if (processQueue.getMaxSpan() &gt; this.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) &#123;
                this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);
                if ((queueMaxSpanFlowControlTimes++ % 1000) &#x3D;&#x3D; 0) &#123;
                    log.warn(
                        &quot;the queue&#39;s messages, span too long, so do flow control, minOffset&#x3D;&#123;&#125;, maxOffset&#x3D;&#123;&#125;, maxSpan&#x3D;&#123;&#125;, pullRequest&#x3D;&#123;&#125;, flowControlTimes&#x3D;&#123;&#125;&quot;,
                        processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),
                        pullRequest, queueMaxSpanFlowControlTimes);
                &#125;
                return;
            &#125;
        &#125; else &#123;
            if (processQueue.isLocked()) &#123;
                if (!pullRequest.isLockedFirst()) &#123;
                    final long offset &#x3D; this.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());
                    boolean brokerBusy &#x3D; offset &lt; pullRequest.getNextOffset();
                    log.info(&quot;the first time to pull message, so fix offset from broker. pullRequest: &#123;&#125; NewOffset: &#123;&#125; brokerBusy: &#123;&#125;&quot;,
                        pullRequest, offset, brokerBusy);
                    if (brokerBusy) &#123;
                        log.info(&quot;[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: &#123;&#125; NewOffset: &#123;&#125;&quot;,
                            pullRequest, offset);
                    &#125;

                    pullRequest.setLockedFirst(true);
                    pullRequest.setNextOffset(offset);
                &#125;
            &#125; else &#123;
                this.executePullRequestLater(pullRequest, pullTimeDelayMillsWhenException);
                log.info(&quot;pull message later because not locked in broker, &#123;&#125;&quot;, pullRequest);
                return;
            &#125;
        &#125;

        &#x2F;&#x2F; ä»¥PullRequest.messageQueueå¯¹è±¡çš„topicå€¼ä¸ºå‚æ•°ä»RebalanceImpl.subscriptionInner: ConcurrentHashMap, SubscriptionData&gt;ä¸­è·å–å¯¹åº”çš„SubscriptionDataå¯¹è±¡ï¼Œè‹¥è¯¥å¯¹è±¡ä¸ºnullï¼Œè€ƒè™‘åˆ°å¹¶å‘çš„å…³ç³»ï¼Œè°ƒç”¨executePullRequestLateræ–¹æ³•ï¼Œç¨åé‡è¯•ï¼›å¹¶è·³å‡ºè¯¥æ–¹æ³•ï¼›
        final SubscriptionData subscriptionData &#x3D; this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());
        if (null &#x3D;&#x3D; subscriptionData) &#123;
            this.executePullRequestLater(pullRequest, pullTimeDelayMillsWhenException);
            log.warn(&quot;find the consumer&#39;s subscription failed, &#123;&#125;&quot;, pullRequest);
            return;
        &#125;

        final long beginTimestamp &#x3D; System.currentTimeMillis();

        &#x2F;&#x2F; å¼‚æ­¥æ‹‰å–å›è°ƒï¼Œå…ˆä¸è®¨è®ºç»†èŠ‚
        PullCallback pullCallback &#x3D; new PullCallback() &#123;
            @Override
            public void onSuccess(PullResult pullResult) &#123;
                if (pullResult !&#x3D; null) &#123;
                    pullResult &#x3D; DefaultMQPushConsumerImpl.this.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,
                        subscriptionData);

                    switch (pullResult.getPullStatus()) &#123;
                        case FOUND:
                            long prevRequestOffset &#x3D; pullRequest.getNextOffset();
                            pullRequest.setNextOffset(pullResult.getNextBeginOffset());
                            long pullRT &#x3D; System.currentTimeMillis() - beginTimestamp;
                            DefaultMQPushConsumerImpl.this.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),
                                pullRequest.getMessageQueue().getTopic(), pullRT);

                            long firstMsgOffset &#x3D; Long.MAX_VALUE;
                            if (pullResult.getMsgFoundList() &#x3D;&#x3D; null || pullResult.getMsgFoundList().isEmpty()) &#123;
                                DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);
                            &#125; else &#123;
                                firstMsgOffset &#x3D; pullResult.getMsgFoundList().get(0).getQueueOffset();

                                DefaultMQPushConsumerImpl.this.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),
                                    pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());

                                boolean dispatchToConsume &#x3D; processQueue.putMessage(pullResult.getMsgFoundList());
                                DefaultMQPushConsumerImpl.this.consumeMessageService.submitConsumeRequest(
                                    pullResult.getMsgFoundList(),
                                    processQueue,
                                    pullRequest.getMessageQueue(),
                                    dispatchToConsume);

                                if (DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval() &gt; 0) &#123;
                                    DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest,
                                        DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval());
                                &#125; else &#123;
                                    DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);
                                &#125;
                            &#125;

                            if (pullResult.getNextBeginOffset() &lt; prevRequestOffset
                                || firstMsgOffset &lt; prevRequestOffset) &#123;
                                log.warn(
                                    &quot;[BUG] pull message result maybe data wrong, nextBeginOffset: &#123;&#125; firstMsgOffset: &#123;&#125; prevRequestOffset: &#123;&#125;&quot;,
                                    pullResult.getNextBeginOffset(),
                                    firstMsgOffset,
                                    prevRequestOffset);
                            &#125;

                            break;
                        case NO_NEW_MSG:
                            pullRequest.setNextOffset(pullResult.getNextBeginOffset());

                            DefaultMQPushConsumerImpl.this.correctTagsOffset(pullRequest);

                            DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);
                            break;
                        case NO_MATCHED_MSG:
                            pullRequest.setNextOffset(pullResult.getNextBeginOffset());

                            DefaultMQPushConsumerImpl.this.correctTagsOffset(pullRequest);

                            DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);
                            break;
                        case OFFSET_ILLEGAL:
                            log.warn(&quot;the pull request offset illegal, &#123;&#125; &#123;&#125;&quot;,
                                pullRequest.toString(), pullResult.toString());
                            pullRequest.setNextOffset(pullResult.getNextBeginOffset());

                            pullRequest.getProcessQueue().setDropped(true);
                            DefaultMQPushConsumerImpl.this.executeTaskLater(new Runnable() &#123;

                                @Override
                                public void run() &#123;
                                    try &#123;
                                        DefaultMQPushConsumerImpl.this.offsetStore.updateOffset(pullRequest.getMessageQueue(),
                                            pullRequest.getNextOffset(), false);

                                        DefaultMQPushConsumerImpl.this.offsetStore.persist(pullRequest.getMessageQueue());

                                        DefaultMQPushConsumerImpl.this.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());

                                        log.warn(&quot;fix the pull request offset, &#123;&#125;&quot;, pullRequest);
                                    &#125; catch (Throwable e) &#123;
                                        log.error(&quot;executeTaskLater Exception&quot;, e);
                                    &#125;
                                &#125;
                            &#125;, 10000);
                            break;
                        default:
                            break;
                    &#125;
                &#125;
            &#125;

            @Override
            public void onException(Throwable e) &#123;
                if (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;
                    log.warn(&quot;execute the pull request exception&quot;, e);
                &#125;

                DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest, pullTimeDelayMillsWhenException);
            &#125;
        &#125;;
        &#x2F;&#x2F; å¦‚æœä¸ºé›†ç¾¤æ¨¡å¼ï¼Œå³å¯ç½®commitOffsetEnableä¸º true
        boolean commitOffsetEnable &#x3D; false;
        long commitOffsetValue &#x3D; 0L;
        if (MessageModel.CLUSTERING &#x3D;&#x3D; this.defaultMQPushConsumer.getMessageModel()) &#123;
            commitOffsetValue &#x3D; this.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);
            if (commitOffsetValue &gt; 0) &#123;
                commitOffsetEnable &#x3D; true;
            &#125;
        &#125;

        &#x2F;&#x2F; å°†ä¸Šé¢è·å¾—çš„commitOffsetEnableæ›´æ–°åˆ°è®¢é˜…å…³ç³»é‡Œ
        String subExpression &#x3D; null;
        boolean classFilter &#x3D; false;
        SubscriptionData sd &#x3D; this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());
        if (sd !&#x3D; null) &#123;
            if (this.defaultMQPushConsumer.isPostSubscriptionWhenPull() &amp;&amp; !sd.isClassFilterMode()) &#123;
                subExpression &#x3D; sd.getSubString();
            &#125;

            classFilter &#x3D; sd.isClassFilterMode();
        &#125;

        &#x2F;&#x2F; ç»„æˆ sysFlag
        int sysFlag &#x3D; PullSysFlag.buildSysFlag(
            commitOffsetEnable, &#x2F;&#x2F; commitOffset
            true, &#x2F;&#x2F; suspend
            subExpression !&#x3D; null, &#x2F;&#x2F; subscription
            classFilter &#x2F;&#x2F; class filter
        );
        &#x2F;&#x2F; è°ƒç”¨çœŸæ­£çš„æ‹‰å–æ¶ˆæ¯æ¥å£
        try &#123;
            this.pullAPIWrapper.pullKernelImpl(
                pullRequest.getMessageQueue(),
                subExpression,
                subscriptionData.getExpressionType(),
                subscriptionData.getSubVersion(),
                pullRequest.getNextOffset(),
                this.defaultMQPushConsumer.getPullBatchSize(),
                sysFlag,
                commitOffsetValue,
                BROKER_SUSPEND_MAX_TIME_MILLIS,
                CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND,
                CommunicationMode.ASYNC,
                pullCallback
            );
        &#125; catch (Exception e) &#123;
            log.error(&quot;pullKernelImpl exception&quot;, e);
            this.executePullRequestLater(pullRequest, pullTimeDelayMillsWhenException);
        &#125;
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»¥ä¸‹å°±æ˜¯æ‹‰å–æ¶ˆæ¯çš„åº•å±‚ apiï¼Œä¸å¤Ÿä¸æ˜¯ç‰¹åˆ«å¤æ‚ï¼Œä¸»è¦æ˜¯åœ¨æ‰¾ brokerï¼Œå’Œè®¾ç½®è¯·æ±‚å‚æ•°</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public PullResult pullKernelImpl(
    final MessageQueue mq,
    final String subExpression,
    final String expressionType,
    final long subVersion,
    final long offset,
    final int maxNums,
    final int sysFlag,
    final long commitOffset,
    final long brokerSuspendMaxTimeMillis,
    final long timeoutMillis,
    final CommunicationMode communicationMode,
    final PullCallback pullCallback
) throws MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;
    FindBrokerResult findBrokerResult &#x3D;
        this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),
            this.recalculatePullFromWhichNode(mq), false);
    if (null &#x3D;&#x3D; findBrokerResult) &#123;
        this.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());
        findBrokerResult &#x3D;
            this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),
                this.recalculatePullFromWhichNode(mq), false);
    &#125;

    if (findBrokerResult !&#x3D; null) &#123;
        &#123;
            &#x2F;&#x2F; check version
            if (!ExpressionType.isTagType(expressionType)
                &amp;&amp; findBrokerResult.getBrokerVersion() &lt; MQVersion.Version.V4_1_0_SNAPSHOT.ordinal()) &#123;
                throw new MQClientException(&quot;The broker[&quot; + mq.getBrokerName() + &quot;, &quot;
                    + findBrokerResult.getBrokerVersion() + &quot;] does not upgrade to support for filter message by &quot; + expressionType, null);
            &#125;
        &#125;
        int sysFlagInner &#x3D; sysFlag;

        if (findBrokerResult.isSlave()) &#123;
            sysFlagInner &#x3D; PullSysFlag.clearCommitOffsetFlag(sysFlagInner);
        &#125;

        PullMessageRequestHeader requestHeader &#x3D; new PullMessageRequestHeader();
        requestHeader.setConsumerGroup(this.consumerGroup);
        requestHeader.setTopic(mq.getTopic());
        requestHeader.setQueueId(mq.getQueueId());
        requestHeader.setQueueOffset(offset);
        requestHeader.setMaxMsgNums(maxNums);
        requestHeader.setSysFlag(sysFlagInner);
        requestHeader.setCommitOffset(commitOffset);
        requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);
        requestHeader.setSubscription(subExpression);
        requestHeader.setSubVersion(subVersion);
        requestHeader.setExpressionType(expressionType);

        String brokerAddr &#x3D; findBrokerResult.getBrokerAddr();
        if (PullSysFlag.hasClassFilterFlag(sysFlagInner)) &#123;
            brokerAddr &#x3D; computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);
        &#125;

        PullResult pullResult &#x3D; this.mQClientFactory.getMQClientAPIImpl().pullMessage(
            brokerAddr,
            requestHeader,
            timeoutMillis,
            communicationMode,
            pullCallback);

        return pullResult;
    &#125;

    throw new MQClientException(&quot;The broker[&quot; + mq.getBrokerName() + &quot;] not exist&quot;, null);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å†çœ‹ä¸‹ä¸€æ­¥çš„</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public PullResult pullMessage(
    final String addr,
    final PullMessageRequestHeader requestHeader,
    final long timeoutMillis,
    final CommunicationMode communicationMode,
    final PullCallback pullCallback
) throws RemotingException, MQBrokerException, InterruptedException &#123;
    RemotingCommand request &#x3D; RemotingCommand.createRequestCommand(RequestCode.PULL_MESSAGE, requestHeader);

    switch (communicationMode) &#123;
        case ONEWAY:
            assert false;
            return null;
        case ASYNC:
            this.pullMessageAsync(addr, request, timeoutMillis, pullCallback);
            return null;
        case SYNC:
            return this.pullMessageSync(addr, request, timeoutMillis);
        default:
            assert false;
            break;
    &#125;

    return null;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šè¿‡ communicationMode åˆ¤æ–­æ˜¯åŒæ­¥æ‹‰å–è¿˜æ˜¯å¼‚æ­¥æ‹‰å–ï¼Œå¼‚æ­¥å°±è°ƒç”¨</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">private void pullMessageAsync(
        final String addr,
        final RemotingCommand request,
        final long timeoutMillis,
        final PullCallback pullCallback
    ) throws RemotingException, InterruptedException &#123;
        this.remotingClient.invokeAsync(addr, request, timeoutMillis, new InvokeCallback() &#123;
            @Override
            public void operationComplete(ResponseFuture responseFuture) &#123;
                å¼‚æ­¥
                RemotingCommand response &#x3D; responseFuture.getResponseCommand();
                if (response !&#x3D; null) &#123;
                    try &#123;
                        PullResult pullResult &#x3D; MQClientAPIImpl.this.processPullResponse(response);
                        assert pullResult !&#x3D; null;
                        pullCallback.onSuccess(pullResult);
                    &#125; catch (Exception e) &#123;
                        pullCallback.onException(e);
                    &#125;
                &#125; else &#123;
                    if (!responseFuture.isSendRequestOK()) &#123;
                        pullCallback.onException(new MQClientException(&quot;send request failed to &quot; + addr + &quot;. Request: &quot; + request, responseFuture.getCause()));
                    &#125; else if (responseFuture.isTimeout()) &#123;
                        pullCallback.onException(new MQClientException(&quot;wait response from &quot; + addr + &quot; timeout :&quot; + responseFuture.getTimeoutMillis() + &quot;ms&quot; + &quot;. Request: &quot; + request,
                            responseFuture.getCause()));
                    &#125; else &#123;
                        pullCallback.onException(new MQClientException(&quot;unknown reason. addr: &quot; + addr + &quot;, timeoutMillis: &quot; + timeoutMillis + &quot;. Request: &quot; + request, responseFuture.getCause()));
                    &#125;
                &#125;
            &#125;
        &#125;);
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¹¶ä¸”ä¼šè°ƒç”¨å‰é¢ pullCallback çš„onSuccesså’ŒonExceptionæ–¹æ³•ï¼ŒåŒæ­¥çš„å°±æ˜¯è°ƒç”¨</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">private PullResult pullMessageSync(
        final String addr,
        final RemotingCommand request,
        final long timeoutMillis
    ) throws RemotingException, InterruptedException, MQBrokerException &#123;
        RemotingCommand response &#x3D; this.remotingClient.invokeSync(addr, request, timeoutMillis);
        assert response !&#x3D; null;
        return this.processPullResponse(response);
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åå°±æ˜¯è¿™ä¸ª remotingClient çš„ invokeAsync è·Ÿ invokeSync æ–¹æ³•</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">@Override
    public void invokeAsync(String addr, RemotingCommand request, long timeoutMillis, InvokeCallback invokeCallback)
        throws InterruptedException, RemotingConnectException, RemotingTooMuchRequestException, RemotingTimeoutException,
        RemotingSendRequestException &#123;
        long beginStartTime &#x3D; System.currentTimeMillis();
        final Channel channel &#x3D; this.getAndCreateChannel(addr);
        if (channel !&#x3D; null &amp;&amp; channel.isActive()) &#123;
            try &#123;
                doBeforeRpcHooks(addr, request);
                long costTime &#x3D; System.currentTimeMillis() - beginStartTime;
                if (timeoutMillis &lt; costTime) &#123;
                    throw new RemotingTooMuchRequestException(&quot;invokeAsync call timeout&quot;);
                &#125;
                this.invokeAsyncImpl(channel, request, timeoutMillis - costTime, invokeCallback);
            &#125; catch (RemotingSendRequestException e) &#123;
                log.warn(&quot;invokeAsync: send request exception, so close the channel[&#123;&#125;]&quot;, addr);
                this.closeChannel(addr, channel);
                throw e;
            &#125;
        &#125; else &#123;
            this.closeChannel(addr, channel);
            throw new RemotingConnectException(addr);
        &#125;
    &#125;
@Override
    public RemotingCommand invokeSync(String addr, final RemotingCommand request, long timeoutMillis)
        throws InterruptedException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException &#123;
        long beginStartTime &#x3D; System.currentTimeMillis();
        final Channel channel &#x3D; this.getAndCreateChannel(addr);
        if (channel !&#x3D; null &amp;&amp; channel.isActive()) &#123;
            try &#123;
                doBeforeRpcHooks(addr, request);
                long costTime &#x3D; System.currentTimeMillis() - beginStartTime;
                if (timeoutMillis &lt; costTime) &#123;
                    throw new RemotingTimeoutException(&quot;invokeSync call timeout&quot;);
                &#125;
                RemotingCommand response &#x3D; this.invokeSyncImpl(channel, request, timeoutMillis - costTime);
                doAfterRpcHooks(RemotingHelper.parseChannelRemoteAddr(channel), request, response);
                return response;
            &#125; catch (RemotingSendRequestException e) &#123;
                log.warn(&quot;invokeSync: send request exception, so close the channel[&#123;&#125;]&quot;, addr);
                this.closeChannel(addr, channel);
                throw e;
            &#125; catch (RemotingTimeoutException e) &#123;
                if (nettyClientConfig.isClientCloseSocketIfTimeout()) &#123;
                    this.closeChannel(addr, channel);
                    log.warn(&quot;invokeSync: close socket because of timeout, &#123;&#125;ms, &#123;&#125;&quot;, timeoutMillis, addr);
                &#125;
                log.warn(&quot;invokeSync: wait response timeout exception, the channel[&#123;&#125;]&quot;, addr);
                throw e;
            &#125;
        &#125; else &#123;
            this.closeChannel(addr, channel);
            throw new RemotingConnectException(addr);
        &#125;
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å†å¾€ä¸‹çœ‹</p>
<pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public RemotingCommand invokeSyncImpl(final Channel channel, final RemotingCommand request,
        final long timeoutMillis)
        throws InterruptedException, RemotingSendRequestException, RemotingTimeoutException &#123;
        final int opaque &#x3D; request.getOpaque();

        try &#123;
            åŒæ­¥è·Ÿå¼‚æ­¥éƒ½æ˜¯ä¼šæŠŠç»“æœç”¨ResponseFutureæŠ±èµ·æ¥
            final ResponseFuture responseFuture &#x3D; new ResponseFuture(channel, opaque, timeoutMillis, null, null);
            this.responseTable.put(opaque, responseFuture);
            final SocketAddress addr &#x3D; channel.remoteAddress();
            channel.writeAndFlush(request).addListener(new ChannelFutureListener() &#123;
                @Override
                public void operationComplete(ChannelFuture f) throws Exception &#123;
                    if (f.isSuccess()) &#123;
                        responseFuture.setSendRequestOK(true);
                        return;
                    &#125; else &#123;
                        responseFuture.setSendRequestOK(false);
                    &#125;

                    responseTable.remove(opaque);
                    responseFuture.setCause(f.cause());
                    responseFuture.putResponse(null);
                    log.warn(&quot;send a request command to channel &lt;&quot; + addr + &quot;&gt; failed.&quot;);
                &#125;
            &#125;);
            &#x2F;&#x2F; åŒºåˆ«æ˜¯åŒæ­¥çš„æ˜¯åœ¨è¿™ç­‰å¾…
            RemotingCommand responseCommand &#x3D; responseFuture.waitResponse(timeoutMillis);
            if (null &#x3D;&#x3D; responseCommand) &#123;
                if (responseFuture.isSendRequestOK()) &#123;
                    throw new RemotingTimeoutException(RemotingHelper.parseSocketAddressAddr(addr), timeoutMillis,
                        responseFuture.getCause());
                &#125; else &#123;
                    throw new RemotingSendRequestException(RemotingHelper.parseSocketAddressAddr(addr), responseFuture.getCause());
                &#125;
            &#125;

            return responseCommand;
        &#125; finally &#123;
            this.responseTable.remove(opaque);
        &#125;
    &#125;

    public void invokeAsyncImpl(final Channel channel, final RemotingCommand request, final long timeoutMillis,
        final InvokeCallback invokeCallback)
        throws InterruptedException, RemotingTooMuchRequestException, RemotingTimeoutException, RemotingSendRequestException &#123;
        long beginStartTime &#x3D; System.currentTimeMillis();
        final int opaque &#x3D; request.getOpaque();
        boolean acquired &#x3D; this.semaphoreAsync.tryAcquire(timeoutMillis, TimeUnit.MILLISECONDS);
        if (acquired) &#123;
            final SemaphoreReleaseOnlyOnce once &#x3D; new SemaphoreReleaseOnlyOnce(this.semaphoreAsync);
            long costTime &#x3D; System.currentTimeMillis() - beginStartTime;
            if (timeoutMillis &lt; costTime) &#123;
                once.release();
                throw new RemotingTimeoutException(&quot;invokeAsyncImpl call timeout&quot;);
            &#125;

            final ResponseFuture responseFuture &#x3D; new ResponseFuture(channel, opaque, timeoutMillis - costTime, invokeCallback, once);
            this.responseTable.put(opaque, responseFuture);
            try &#123;
                channel.writeAndFlush(request).addListener(new ChannelFutureListener() &#123;
                    @Override
                    public void operationComplete(ChannelFuture f) throws Exception &#123;
                        if (f.isSuccess()) &#123;
                            responseFuture.setSendRequestOK(true);
                            return;
                        &#125;
                        requestFail(opaque);
                        log.warn(&quot;send a request command to channel &lt;&#123;&#125;&gt; failed.&quot;, RemotingHelper.parseChannelRemoteAddr(channel));
                    &#125;
                &#125;);
            &#125; catch (Exception e) &#123;
                responseFuture.release();
                log.warn(&quot;send a request command to channel &lt;&quot; + RemotingHelper.parseChannelRemoteAddr(channel) + &quot;&gt; Exception&quot;, e);
                throw new RemotingSendRequestException(RemotingHelper.parseChannelRemoteAddr(channel), e);
            &#125;
        &#125; else &#123;
            if (timeoutMillis &lt;&#x3D; 0) &#123;
                throw new RemotingTooMuchRequestException(&quot;invokeAsyncImpl invoke too fast&quot;);
            &#125; else &#123;
                String info &#x3D;
                    String.format(&quot;invokeAsyncImpl tryAcquire semaphore timeout, %dms, waiting thread nums: %d semaphoreAsyncValue: %d&quot;,
                        timeoutMillis,
                        this.semaphoreAsync.getQueueLength(),
                        this.semaphoreAsync.availablePermits()
                    );
                log.warn(info);
                throw new RemotingTimeoutException(info);
            &#125;
        &#125;
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://nicksxs.me/2020/06/21/%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8B-RocketMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="Nicksxs">
      <meta itemprop="description" content="learn from zero,æŠ€æœ¯åšå®¢ï¼ŒNicksxsï¼Œå²å­¦æ£®">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Nicksxs's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/21/%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8B-RocketMQ/" class="post-title-link" itemprop="url">ä»‹ç»ä¸€ä¸‹ RocketMQ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-21 21:25:22" itemprop="dateCreated datePublished" datetime="2020-06-21T21:25:22+08:00">2020-06-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ¶ˆæ¯é˜Ÿåˆ—</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">ä¸­é—´ä»¶</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
                </span>
            </span>

          
            <span id="/2020/06/21/%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8B-RocketMQ/" class="post-meta-item leancloud_visitors" data-flag-title="ä»‹ç»ä¸€ä¸‹ RocketMQ" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/06/21/%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8B-RocketMQ/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/06/21/ä»‹ç»ä¸€ä¸‹-RocketMQ/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è¯´èµ·æ¶ˆæ¯é˜Ÿåˆ—ä¸€èˆ¬Webåç«¯åšè¿‡ä¸€æ®µæ—¶é—´å¼€å‘çš„è‚¯å®šä¼šç”¨è¿‡ï¼Œåœ¨å‰å¸çš„æ—¶å€™ç”¨çš„æ˜¯æ”¹è‰¯ç‰ˆçš„ NSQï¼Œæœ‰ç‚¹åƒ NOSQL çš„ç®€å†™ç‰ˆğŸ™„ï¼Œå…¶å®æ˜¯ä¸ªgo è¯­è¨€å†™çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/nsqio/nsq">nsq</a> çœ‹ä»£ç æäº¤æ„Ÿè§‰æœ€è¿‘æ›´æ–°çš„ä¸æ˜¯å¾ˆå‹¤ï¼Œä¸è¿‡å› ä¸ºå‰å¸æœ‰ä¸“é—¨çš„ä¸­é—´ä»¶å›¢é˜Ÿï¼Œæ‰€ä»¥è¿˜æ˜¯æŒºå¥½ç”¨çš„ï¼Œè€Œä¸”ä¸­é—´ä»¶å›¢é˜Ÿçš„å¤§ç‰›ä¹Ÿå¾ˆå‰å®³ï¼Œä¸€æ¬¡éƒ½æ²¡ç¢°åˆ°è¿‡ä¸¢æ¶ˆæ¯ä¹‹ç±»çš„é”™è¯¯ï¼Œç„¶åç°åœ¨å…¬å¸ç”¨çš„æ˜¯ RocketMQï¼Œæœ¬ç€æ€»è¿˜æ˜¯è¦äº†è§£ä¸‹çš„ï¼Œå¹¶ä¸”æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæ˜¯æœåŠ¡ç«¯å¼€å‘ä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸­é—´ä»¶ï¼Œå› ä¸ºä¸å¤ªæœ‰ä¸éœ€è¦ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„åç«¯å›¢é˜Ÿäº†å§ï¼ŒåŸæ¥å¯¹ nsq ä¹Ÿä¸æ˜¯ç‰¹åˆ«äº†è§£åŸç†ï¼Œå°±æ‰“ç®—äº†è§£ä¸‹ RocketMQã€‚</p>
<p>è¿˜æ˜¯åƒæˆ‘è¿™æ ·çš„å°ç™½ä¸“å±ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç”¨æ¥å¹²å•¥ï¼Œå¾ˆå¤šéƒ½æ˜¯æ ‡å‡†ç­”æ¡ˆï¼Œç”¨æ¥å‰Šå³°å¡«è°·çš„ï¼Œè¿™ä¸ªå®Œå…¨å¯¹ï¼Œåªæ˜¯æˆ‘æƒ³ç»“åˆåœºæ™¯è¯´ç»™åƒæˆ‘è¿™æ ·çš„å°ç™½åŒå­¦å¬ï¼Œæƒ³æƒ³ä¸€ä¸ªç”µå•†çš„ä¸‹å•åŠŸèƒ½ï¼Œé™¤äº† AT ä¸¤å®¶ä¹‹å¤–åº”è¯¥å¤§éƒ¨åˆ†éƒ½æ˜¯æ¥å…¥çš„æ”¯ä»˜ï¼Œé‚£ä¹ˆä¸‹å•æ”¯ä»˜å®Œæˆåä¸€èˆ¬éƒ½æ˜¯ç­‰æ”¯ä»˜å›è°ƒï¼Œå‘Šè¯‰ä½ æ”¯ä»˜å®Œæˆäº†ï¼ˆä¹Ÿæœ‰å¯èƒ½æ˜¯å¤±è´¥äº†ï¼Œæˆ–è€…è¶…æ—¶äº†å’±ä»¬ä¸»åŠ¨å»æŸ¥ï¼‰ï¼Œç„¶åè¿™ä¸ªå›è°ƒé‡Œæˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡ä»£ç å¹²ç‚¹å•¥ï¼Œé¦–å…ˆæ¯”å¦‚æ˜¯æŠŠè®¢å•çŠ¶æ€æ”¹æ‰äº†ï¼Œç„¶åä¼šæœ‰å„ç±»çš„æ“ä½œï¼Œæ¯”å¦‚æŠŠä¼˜æƒ åˆ¸æ ¸é”€äº†ï¼ŒæŠŠå…¶ä»–é‡‘é’±ç›¸å…³çš„ä¹Ÿæ ¸é”€äº†ï¼ŒæŠŠè´­ç‰©è½¦é‡Œå¯¹åº”çš„å•†å“ç»™åˆ äº†ï¼Œè¿˜æœ‰æ›´æ¬¡è¦çš„ï¼Œæ¯”å¦‚å‘ä¸ªå®¢æœæ¶ˆæ¯ï¼Œè®©ç”¨æˆ·ç¡®è®¤ä¸‹åœ°å€çš„ï¼Œç»™ç”¨æˆ·åŠ ç§¯åˆ†çš„ç­‰ç­‰ç­‰ç­‰ï¼Œæƒ³è±¡ä¸‹å¦‚æœè¿™äº›éƒ½æ˜¯å›è°ƒé‡Œä¸€è‚¡è„‘å„¿åšæ‰äº†ï¼Œé‚£å¯èƒ½ä½ çš„ä»£ç å¥å£®æ€§è·Ÿç›¸å…³æœåŠ¡çš„ç¨³å®šæ€§è¿˜æœ‰æ€§èƒ½è¦è¾¾åˆ°ä¸€ä¸ªéå¸¸é«˜çš„æ°´å¹³æ‰èƒ½è®©ä¸šåŠ¡ä¸å‡ºç°å¼‚å¸¸ï¼Œå¹¶ä¸”ä¸‡ä¸€æµé‡æ‰“èµ·æ¥äº†ï¼Œè¿™äº›é‡è¦çš„ä¸é‡è¦çš„æ“ä½œéƒ½ä¼šé˜»å¡ç€ï¼Œæ‰€ä»¥éœ€è¦ç”¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨æ¥åˆ°å›è°ƒååªå¤„ç†æå°‘çš„å‡ ä¸ªæ ¸å¿ƒæ“ä½œï¼Œå®Œäº†å°±æŠŠè¿™ä¸ªæ¶ˆæ¯ä¸¢è¿›æ¶ˆæ¯é˜Ÿåˆ—é‡Œï¼Œè®©å„ä¸ªä¸šåŠ¡æ–¹å»æ¶ˆè´¹è¿™ä¸ªæ¶ˆæ¯ï¼ŒæŠŠå®¢æœæ¶ˆæ¯å‘ä¸€ä¸‹ï¼Œç»™ç”¨æˆ·åŠ ä¸ªç§¯åˆ†ç­‰ç­‰ï¼Œè¿™æ ·å­ä¸»è¦çš„ä¸šåŠ¡æµç¨‹éœ€è¦å¤„ç†çš„äº‹æƒ…å°±å°‘äº†ï¼Œé€Ÿåº¦ä¹ŸåŠ å¿«äº†ï¼Œè¿™ä¸ªä¾‹å­å‘¢ä¸èƒ½ä¸¥æ ¼ç®—æ˜¯å‰Šå³°å¡«è°·çš„ä¾‹å­ï¼Œä¸è¿‡ä¹Ÿç®—æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„æ¯”è¾ƒå…¸å‹çš„ä½¿ç”¨åœºæ™¯äº†ï¼Œè¦è¯´çœŸå®çš„å‰Šå³°å¡«è°·çš„è¯å…¶å®å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œå‡å¦‚çŸ­æ—¶é—´å†…æœ‰ 1w ä¸ªè¯·æ±‚è¿›æ¥ï¼Œç³»ç»Ÿèƒ½æ”¯æŒçš„ QPS æ‰ 1000ï¼Œé‚£ä¹ˆæ­£å¸¸æƒ…å†µä¸‹æœåŠ¡å°±æŒ‚äº†ï¼Œæˆ–è€…è¢«é™æµäº†ï¼Œä¸ºäº†è®©æœåŠ¡æ­£å¸¸ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠè¿™äº›è¯·æ±‚å…ˆæ”¾è¿›æ¶ˆæ¯é˜Ÿåˆ—é‡Œï¼Œæˆ‘æœåŠ¡ç«¯ä»¥æ‹‰çš„æ¨¡å¼æŒ‰æˆ‘çš„å¤„ç†èƒ½åŠ›æ¥æ¶ˆè´¹ï¼Œè¿™æ ·å°±æ²¡å•¥é—®é¢˜äº†</p>
<p>æ‰¯äº†è¿™ä¹ˆå¤šæ¥èŠèŠ RocketMQ é•¿å•¥æ ·</p>
<p><img data-src="https://mystore-1255223546.cos.ap-chengdu.myqcloud.com/uPic/6073827-a998e005dd13967c.png" alt="6073827-a998e005dd13967c"></p>
<p>æ€»å…±æœ‰å››å¤§éƒ¨åˆ†ï¼š<strong>NameServerï¼ŒBrokerï¼ŒProducerï¼ŒConsumerã€‚</strong></p>
<h4 id="NameServer"><a href="#NameServer" class="headerlink" title="NameServer"></a>NameServer</h4><p>NameServeræ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„Topicè·¯ç”±æ³¨å†Œä¸­å¿ƒï¼Œå…¶è§’è‰²ç±»ä¼¼Dubboä¸­çš„zookeeperï¼Œæ”¯æŒBrokerçš„åŠ¨æ€æ³¨å†Œä¸å‘ç°ã€‚ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªåŠŸèƒ½ï¼šBrokerç®¡ç†ï¼ŒNameServeræ¥å—Brokeré›†ç¾¤çš„æ³¨å†Œä¿¡æ¯å¹¶ä¸”ä¿å­˜ä¸‹æ¥ä½œä¸ºè·¯ç”±ä¿¡æ¯çš„åŸºæœ¬æ•°æ®ã€‚ç„¶åæä¾›å¿ƒè·³æ£€æµ‹æœºåˆ¶ï¼Œæ£€æŸ¥Brokeræ˜¯å¦è¿˜å­˜æ´»ï¼›è·¯ç”±ä¿¡æ¯ç®¡ç†ï¼Œæ¯ä¸ªNameServerå°†ä¿å­˜å…³äºBrokeré›†ç¾¤çš„æ•´ä¸ªè·¯ç”±ä¿¡æ¯å’Œç”¨äºå®¢æˆ·ç«¯æŸ¥è¯¢çš„é˜Ÿåˆ—ä¿¡æ¯ã€‚ç„¶åProducerå’ŒConumseré€šè¿‡NameServerå°±å¯ä»¥çŸ¥é“æ•´ä¸ªBrokeré›†ç¾¤çš„è·¯ç”±ä¿¡æ¯ï¼Œä»è€Œè¿›è¡Œæ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹ã€‚NameServeré€šå¸¸ä¹Ÿæ˜¯é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œå„å®ä¾‹é—´ç›¸äº’ä¸è¿›è¡Œä¿¡æ¯é€šè®¯ã€‚Brokeræ˜¯å‘æ¯ä¸€å°NameServeræ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªNameServerå®ä¾‹ä¸Šé¢éƒ½ä¿å­˜ä¸€ä»½å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ã€‚å½“æŸä¸ªNameServerå› æŸç§åŸå› ä¸‹çº¿äº†ï¼ŒBrokerä»ç„¶å¯ä»¥å‘å…¶å®ƒNameServeråŒæ­¥å…¶è·¯ç”±ä¿¡æ¯ï¼ŒProducer,Consumerä»ç„¶å¯ä»¥åŠ¨æ€æ„ŸçŸ¥Brokerçš„è·¯ç”±çš„ä¿¡æ¯ã€‚</p>
<p>NameServerå‹åŠ›ä¸ä¼šå¤ªå¤§ï¼Œæ­£å¸¸æƒ…å†µä¸»è¦è´Ÿè´£ç»´æŒå¿ƒè·³å’Œæä¾›Topic-Brokerçš„å…³ç³»æ•°æ®ã€‚ä½†æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼ŒBrokerå‘Namesrå‘å¿ƒè·³æ—¶ï¼Œä¼šå¸¦ä¸Šå½“å‰è‡ªå·±æ‰€è´Ÿè´£çš„æ‰€æœ‰Topicä¿¡æ¯ï¼Œ<strong>å¦‚æœTopicä¸ªæ•°å¤ªå¤šï¼Œä¼šå¯¼è‡´ä¸€æ¬¡å¿ƒè·³ä¸­ï¼Œå…‰Topicçš„æ•°æ®å°±éå¸¸å¤§ï¼Œç½‘ç»œæƒ…å†µå·®çš„è¯ï¼Œç½‘ç»œä¼ è¾“å¤±è´¥ï¼Œå¿ƒè·³å¤±è´¥ï¼Œå¯¼è‡´Namesrvè¯¯è®¤ä¸ºBrokerå¿ƒè·³å¤±è´¥ã€‚</strong></p>
<h4 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h4><p>Brokerä¸»è¦è´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨ã€æŠ•é€’å’ŒæŸ¥è¯¢ä»¥åŠæœåŠ¡é«˜å¯ç”¨ä¿è¯ï¼Œä¸ºäº†å®ç°è¿™äº›åŠŸèƒ½ï¼ŒBrokeråŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªé‡è¦å­æ¨¡å—ã€‚</p>
<ul>
<li>Remoting Moduleï¼šæ•´ä¸ªBrokerçš„å®ä½“ï¼Œè´Ÿè´£å¤„ç†æ¥è‡ªclientsç«¯çš„è¯·æ±‚ã€‚</li>
<li>Client Managerï¼šè´Ÿè´£ç®¡ç†å®¢æˆ·ç«¯(Producer/Consumer)å’Œç»´æŠ¤Consumerçš„Topicè®¢é˜…ä¿¡æ¯</li>
<li>Store Serviceï¼šæä¾›æ–¹ä¾¿ç®€å•çš„APIæ¥å£å¤„ç†æ¶ˆæ¯å­˜å‚¨åˆ°ç‰©ç†ç¡¬ç›˜å’ŒæŸ¥è¯¢åŠŸèƒ½ã€‚</li>
<li>HA Serviceï¼šé«˜å¯ç”¨æœåŠ¡ï¼Œæä¾›Master Broker å’Œ Slave Brokerä¹‹é—´çš„æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚</li>
<li>Index Serviceï¼šæ ¹æ®ç‰¹å®šçš„Message keyå¯¹æŠ•é€’åˆ°Brokerçš„æ¶ˆæ¯è¿›è¡Œç´¢å¼•æœåŠ¡ï¼Œä»¥æä¾›æ¶ˆæ¯çš„å¿«é€ŸæŸ¥è¯¢ã€‚</li>
</ul>
<h6 id="Brokerçš„ç‰¹ç‚¹"><a href="#Brokerçš„ç‰¹ç‚¹" class="headerlink" title="Brokerçš„ç‰¹ç‚¹"></a>Brokerçš„ç‰¹ç‚¹</h6><p><strong>1.è´Ÿè½½å‡è¡¡ï¼š</strong>Brokerä¸Šå­˜Topicä¿¡æ¯ï¼Œ<strong>Topicç”±å¤šä¸ªé˜Ÿåˆ—ç»„æˆï¼Œé˜Ÿåˆ—ä¼šå¹³å‡åˆ†æ•£åœ¨å¤šä¸ªBrokerä¸Šï¼Œ</strong>è€ŒProducerçš„å‘é€æœºåˆ¶ä¿è¯æ¶ˆæ¯å°½é‡å¹³å‡åˆ†å¸ƒåˆ°æ‰€æœ‰é˜Ÿåˆ—ä¸­ï¼Œ<strong>æœ€ç»ˆæ•ˆæœå°±æ˜¯æ‰€æœ‰æ¶ˆæ¯éƒ½å¹³å‡è½åœ¨æ¯ä¸ªBrokerä¸Šã€‚</strong></p>
<p><strong>2.åŠ¨æ€ä¼¸ç¼©èƒ½åŠ›ï¼ˆéé¡ºåºæ¶ˆæ¯ï¼‰</strong>ï¼šBrokerçš„ä¼¸ç¼©æ€§ä½“ç°åœ¨ä¸¤ä¸ªç»´åº¦ï¼šTopic, Brokerã€‚</p>
<blockquote>
<p><strong>Topicç»´åº¦ï¼š</strong>å‡å¦‚ä¸€ä¸ªTopicçš„æ¶ˆæ¯é‡ç‰¹åˆ«å¤§ï¼Œä½†é›†ç¾¤æ°´ä½å‹åŠ›è¿˜æ˜¯å¾ˆä½ï¼Œå°±å¯ä»¥æ‰©å¤§è¯¥Topicçš„é˜Ÿåˆ—æ•°ï¼ŒTopicçš„é˜Ÿåˆ—æ•°è·Ÿå‘é€ã€æ¶ˆè´¹é€Ÿåº¦æˆæ­£æ¯”ã€‚<br> <strong>Brokerç»´åº¦ï¼š</strong>å¦‚æœé›†ç¾¤æ°´ä½å¾ˆé«˜äº†ï¼Œéœ€è¦æ‰©å®¹ï¼Œç›´æ¥åŠ æœºå™¨éƒ¨ç½²Brokerå°±å¯ä»¥ã€‚Brokerèµ·æ¥åæƒ³NameServeræ³¨å†Œï¼ŒProducerã€Consumeré€šè¿‡NameServerå‘ç°æ–°Brokerï¼Œç«‹å³è·Ÿè¯¥Brokerç›´è¿ï¼Œæ”¶å‘æ¶ˆæ¯ã€‚</p>
</blockquote>
<p><strong>3.é«˜å¯ç”¨&amp;é«˜å¯é </strong></p>
<blockquote>
<p><strong>é«˜å¯ç”¨ï¼š</strong>é›†ç¾¤éƒ¨ç½²æ—¶ä¸€èˆ¬éƒ½ä¸ºä¸»å¤‡ï¼Œå¤‡æœºå®æ—¶ä»ä¸»æœºåŒæ­¥æ¶ˆæ¯ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªä¸»æœºå®•æœºï¼Œå¤‡æœºæä¾›æ¶ˆè´¹æœåŠ¡ï¼Œä½†ä¸æä¾›å†™æœåŠ¡ã€‚<br> <strong>é«˜å¯é ï¼š</strong>æ‰€æœ‰å‘å¾€brokerçš„æ¶ˆæ¯ï¼Œæœ‰åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜æœºåˆ¶ï¼›åŒæ­¥åˆ·ç›˜æ—¶ï¼Œæ¶ˆæ¯å†™å…¥ç‰©ç†æ–‡ä»¶æ‰ä¼šè¿”å›æˆåŠŸï¼Œå¼‚æ­¥åˆ·ç›˜æ—¶ï¼Œåªæœ‰æœºå™¨å®•æœºï¼Œæ‰ä¼šäº§ç”Ÿæ¶ˆæ¯ä¸¢å¤±ï¼ŒbrokeræŒ‚æ‰å¯èƒ½ä¼šå‘ç”Ÿï¼Œä½†æ˜¯æœºå™¨å®•æœºå´©æºƒæ˜¯å¾ˆå°‘å‘ç”Ÿçš„ï¼Œé™¤éçªç„¶æ–­ç”µ</p>
</blockquote>
<h4 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h4><p>Producerä¸NameServeré›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä»NameServerè·å–Topicè·¯ç”±ä¿¡æ¯ï¼Œå¹¶å‘æä¾›Topic æœåŠ¡çš„Masterå»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘Masterå‘é€å¿ƒè·³ã€‚Producerå®Œå…¨æ— çŠ¶æ€ï¼Œå¯é›†ç¾¤éƒ¨ç½²ã€‚<br> <strong>RocketMQæä¾›ä¸‰ç§å‘é€æ–¹å¼ï¼š</strong></p>
<blockquote>
<p><strong>åŒæ­¥ï¼š</strong>åœ¨å¹¿æ³›çš„åœºæ™¯ä¸­ä½¿ç”¨å¯é çš„åŒæ­¥ä¼ è¾“ï¼Œå¦‚é‡è¦çš„é€šçŸ¥ä¿¡æ¯ã€çŸ­ä¿¡é€šçŸ¥ã€çŸ­ä¿¡è¥é”€ç³»ç»Ÿç­‰ã€‚<br> <strong>å¼‚æ­¥ï¼š</strong>å¼‚æ­¥å‘é€é€šå¸¸ç”¨äºå“åº”æ—¶é—´æ•æ„Ÿçš„ä¸šåŠ¡åœºæ™¯ï¼Œå‘é€å‡ºå»å³åˆ»è¿”å›ï¼Œåˆ©ç”¨å›è°ƒåšåç»­å¤„ç†ã€‚<br> <strong>ä¸€æ¬¡æ€§ï¼š</strong>ä¸€æ¬¡æ€§å‘é€ç”¨äºéœ€è¦ä¸­ç­‰å¯é æ€§çš„æƒ…å†µï¼Œå¦‚æ—¥å¿—æ”¶é›†ï¼Œå‘é€å‡ºå»å³å®Œæˆï¼Œä¸ç”¨ç­‰å¾…å‘é€ç»“æœï¼Œå›è°ƒç­‰ç­‰ã€‚</p>
</blockquote>
<h6 id="ç”Ÿäº§è€…ç«¯çš„è´Ÿè½½å‡è¡¡"><a href="#ç”Ÿäº§è€…ç«¯çš„è´Ÿè½½å‡è¡¡" class="headerlink" title="ç”Ÿäº§è€…ç«¯çš„è´Ÿè½½å‡è¡¡"></a>ç”Ÿäº§è€…ç«¯çš„è´Ÿè½½å‡è¡¡</h6><p>ç”Ÿäº§è€…å‘é€æ—¶ï¼Œä¼šè‡ªåŠ¨è½®è¯¢å½“å‰æ‰€æœ‰å¯å‘é€çš„brokerï¼Œä¸€æ¡æ¶ˆæ¯å‘é€æˆåŠŸï¼Œä¸‹æ¬¡æ¢å¦å¤–ä¸€ä¸ªbrokerå‘é€ï¼Œä»¥è¾¾åˆ°æ¶ˆæ¯å¹³å‡è½åˆ°æ‰€æœ‰çš„brokerä¸Šã€‚</p>
<h4 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h4><p>Consumerä¸NameServeré›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä»NameServerè·å–Topicè·¯ç”±ä¿¡æ¯ï¼Œå¹¶å‘æä¾›TopicæœåŠ¡çš„Masterã€Slaveå»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘Masterã€Slaveå‘é€å¿ƒè·³ã€‚Consumeræ—¢å¯ä»¥ä»Masterè®¢é˜…æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥ä»Slaveè®¢é˜…æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åœ¨å‘Masteræ‹‰å–æ¶ˆæ¯æ—¶ï¼ŒMasteræœåŠ¡å™¨ä¼šæ ¹æ®æ‹‰å–åç§»é‡ä¸æœ€å¤§åç§»é‡çš„è·ç¦»ï¼ˆåˆ¤æ–­æ˜¯å¦è¯»è€æ¶ˆæ¯ï¼Œäº§ç”Ÿè¯»I/Oï¼‰ï¼Œä»¥åŠä»æœåŠ¡å™¨æ˜¯å¦å¯è¯»ç­‰å› ç´ å»ºè®®ä¸‹ä¸€æ¬¡æ˜¯ä»Masterè¿˜æ˜¯Slaveæ‹‰å–ã€‚</p>
<h6 id="æ¶ˆè´¹è€…ç«¯çš„è´Ÿè½½å‡è¡¡"><a href="#æ¶ˆè´¹è€…ç«¯çš„è´Ÿè½½å‡è¡¡" class="headerlink" title="æ¶ˆè´¹è€…ç«¯çš„è´Ÿè½½å‡è¡¡"></a>æ¶ˆè´¹è€…ç«¯çš„è´Ÿè½½å‡è¡¡</h6><p>å…ˆè®¨è®ºæ¶ˆè´¹è€…çš„æ¶ˆè´¹æ¨¡å¼ï¼Œ<strong>æ¶ˆè´¹è€…æœ‰ä¸¤ç§æ¨¡å¼æ¶ˆè´¹ï¼šé›†ç¾¤æ¶ˆè´¹ï¼Œå¹¿æ’­æ¶ˆè´¹ã€‚</strong></p>
<blockquote>
<p><strong>å¹¿æ’­æ¶ˆè´¹ï¼šæ¯ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹Topicä¸‹çš„æ‰€æœ‰é˜Ÿåˆ—ã€‚</strong><br> <strong>é›†ç¾¤æ¶ˆè´¹ï¼šä¸€ä¸ªtopicå¯ä»¥ç”±åŒä¸€ä¸ªIDä¸‹æ‰€æœ‰æ¶ˆè´¹è€…åˆ†æ‹…æ¶ˆè´¹ã€‚</strong><br> å…·ä½“ä¾‹å­ï¼šå‡å¦‚TopicAæœ‰6ä¸ªé˜Ÿåˆ—ï¼ŒæŸä¸ªæ¶ˆè´¹è€…IDèµ·äº†2ä¸ªæ¶ˆè´¹è€…å®ä¾‹ï¼Œé‚£ä¹ˆæ¯ä¸ªæ¶ˆè´¹è€…è´Ÿè´£æ¶ˆè´¹3ä¸ªé˜Ÿåˆ—ã€‚å¦‚æœå†å¢åŠ ä¸€ä¸ªæ¶ˆè´¹è€…IDç›¸åŒæ¶ˆè´¹è€…å®ä¾‹ï¼Œå³å½“å‰å…±æœ‰3ä¸ªæ¶ˆè´¹è€…åŒæ—¶æ¶ˆè´¹6ä¸ªé˜Ÿåˆ—ï¼Œé‚£æ¯ä¸ªæ¶ˆè´¹è€…è´Ÿè´£2ä¸ªé˜Ÿåˆ—çš„æ¶ˆè´¹ã€‚</p>
</blockquote>
<p>æ¶ˆè´¹è€…ç«¯çš„è´Ÿè½½å‡è¡¡ï¼Œå°±æ˜¯é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼ŒåŒä¸€ä¸ªIDçš„æ‰€æœ‰æ¶ˆè´¹è€…å®ä¾‹å¹³å‡æ¶ˆè´¹è¯¥Topicçš„æ‰€æœ‰é˜Ÿåˆ—ã€‚</p>
<p><strong>æ¶ˆè´¹è€…ä»ç”¨æˆ·è§’åº¦æ¥çœ‹æœ‰ä¸¤ç§ç±»å‹ï¼š</strong></p>
<blockquote>
<p><strong>PullConsumerï¼šä¸»åŠ¨ä»brokerså¤„æ‹‰å–æ¶ˆæ¯ã€‚</strong>Consumeræ¶ˆè´¹çš„ä¸€ç§ç±»å‹ï¼Œåº”ç”¨é€šå¸¸ä¸»åŠ¨è°ƒç”¨Consumerçš„æ‹‰æ¶ˆæ¯æ–¹æ³•ä»BrokeræœåŠ¡å™¨æ‹‰æ¶ˆæ¯ã€ä¸»åŠ¨æƒç”±åº”ç”¨æ§åˆ¶ã€‚ä¸€æ—¦è·å–äº†æ‰¹é‡æ¶ˆæ¯ï¼Œåº”ç”¨å°±ä¼šå¯åŠ¨æ¶ˆè´¹è¿‡ç¨‹ã€‚<br><strong>PushConsumerï¼šConsumeræ¶ˆè´¹çš„ä¸€ç§ç±»å‹ï¼Œè¯¥æ¨¡å¼ä¸‹Brokeræ”¶åˆ°æ•°æ®åä¼šä¸»åŠ¨æ¨é€ç»™æ¶ˆè´¹ç«¯ï¼Œè¯¥æ¶ˆè´¹æ¨¡å¼ä¸€èˆ¬å®æ—¶æ€§è¾ƒé«˜ã€‚</strong></p>
</blockquote>
<h4 id="è¡¥å……ä¸€äº›æ¦‚å¿µ"><a href="#è¡¥å……ä¸€äº›æ¦‚å¿µ" class="headerlink" title="è¡¥å……ä¸€äº›æ¦‚å¿µ"></a>è¡¥å……ä¸€äº›æ¦‚å¿µ</h4><p><strong>Topicï¼šä¸»é¢˜ï¼Œè¡¨ç¤ºä¸€ç±»æ¶ˆæ¯çš„é›†åˆï¼Œæ¯ä¸ªä¸»é¢˜åŒ…å«è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åªèƒ½å±äºä¸€ä¸ªä¸»é¢˜ï¼Œæ˜¯RocketMQè¿›è¡Œæ¶ˆæ¯è®¢é˜…çš„åŸºæœ¬å•ä½ã€‚</strong>Topicä¸ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æ˜¯éå¸¸æ¾æ•£çš„å…³ç³»ï¼Œä¸€ä¸ªtopicå¯ä»¥æœ‰0ä¸ªæˆ–è€…1ä¸ªæˆ–è€…å¤šä¸ªç”Ÿäº§è€…å‘å…¶å‘é€æ¶ˆæ¯ï¼Œæ¢å¥è¯è¯´ï¼Œä¸€ä¸ªç”Ÿäº§è€…å¯ä»¥åŒæ—¶å‘ä¸åŒå’Œtopicå‘é€æ¶ˆæ¯ã€‚ä»æ¶ˆè´¹è€…çš„è§£åº¦æ¥è¯´ï¼Œä¸€ä¸ªtopicå¯èƒ½è¢«0ä¸ªæˆ–è€…ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ¶ˆè´¹ç»„è®¢é˜…ï¼Œç±»ä¼¼çš„ï¼Œä¸€ä¸ªæ¶ˆè´¹ç»„å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸»é¢˜åªè¦è¿™ä¸ªæ¶ˆè´¹ç»„çš„å®ä¾‹ä¿æŒä»–ä»¬çš„è®¢é˜…ä¸€è‡´ã€‚</p>
<p><strong>Messageï¼šæ¶ˆæ¯</strong>æ¶ˆæ¯ç³»ç»Ÿæ‰€ä¼ è¾“ä¿¡æ¯çš„ç‰©ç†è½½ä½“ï¼Œç”Ÿäº§å’Œæ¶ˆè´¹æ•°æ®çš„æœ€å°å•ä½ï¼Œæ¯æ¡æ¶ˆæ¯å¿…é¡»å±äºä¸€ä¸ªä¸»é¢˜ã€‚RocketMQä¸­æ¯ä¸ªæ¶ˆæ¯æ‹¥æœ‰å”¯ä¸€çš„Message IDï¼Œä¸”å¯ä»¥æºå¸¦å…·æœ‰ä¸šåŠ¡æ ‡è¯†çš„Keyã€‚ç³»ç»Ÿæä¾›äº†é€šè¿‡Message IDå’ŒKeyæŸ¥è¯¢æ¶ˆæ¯çš„åŠŸèƒ½ã€‚ã€‚</p>
<p><strong>Message Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œ</strong>ä¸€ä¸ªä¸»é¢˜è¢«åŒ–åˆ†ä¸ºä¸€ä¸ªæˆ–è€…å¤šä¸ªå­ä¸»é¢˜ï¼ˆsub-topicsï¼‰ï¼Œâ€œæ¶ˆæ¯é˜Ÿåˆ—â€.</p>
<p><strong>Tagï¼šæ ‡ç­¾ï¼Œä¸ºæ¶ˆæ¯è®¾ç½®çš„æ ‡å¿—ï¼Œç”¨äºåŒä¸€ä¸»é¢˜ä¸‹åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ã€‚æ¥è‡ªåŒä¸€ä¸šåŠ¡å•å…ƒçš„æ¶ˆæ¯ï¼Œå¯ä»¥æ ¹æ®ä¸åŒä¸šåŠ¡ç›®çš„åœ¨åŒä¸€ä¸»é¢˜ä¸‹è®¾ç½®ä¸åŒæ ‡ç­¾ã€‚æ ‡ç­¾èƒ½å¤Ÿæœ‰æ•ˆåœ°ä¿æŒä»£ç çš„æ¸…æ™°åº¦å’Œè¿è´¯æ€§ï¼Œå¹¶ä¼˜åŒ–RocketMQæä¾›çš„æŸ¥è¯¢ç³»ç»Ÿã€‚æ¶ˆè´¹è€…å¯ä»¥æ ¹æ®Tagå®ç°å¯¹ä¸åŒå­ä¸»é¢˜çš„ä¸åŒæ¶ˆè´¹é€»è¾‘ï¼Œå®ç°æ›´å¥½çš„æ‰©å±•æ€§ã€‚</strong>ä½¿ç”¨tagï¼ŒåŒä¸€ä¸šåŠ¡æ¨¡å—ä¸åŒç›®çš„çš„messageså°±å¯ä»¥ç”¨ç›¸åŒtopicä¸åŒtagæ¥æ ‡è¯†ã€‚Tagsæœ‰ç›Šäºä¿æŒä½ çš„ä»£ç å¹²å‡€è€Œæ¡ç†æ¸…æ™°ï¼ŒåŒæ—¶ä¿ƒè¿›ä½¿ç”¨RocketMQæä¾›çš„æŸ¥è¯¢ç³»ç»Ÿçš„æ•ˆç‡ã€‚Topicï¼šä¸»é¢˜ï¼Œæ˜¯ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯å’Œæ¶ˆè´¹è€…æ‹‰å–çš„æ¶ˆæ¯çš„å½’ç±»ã€‚Topicä¸ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æ˜¯éå¸¸æ¾æ•£çš„å…³ç³»ï¼Œä¸€ä¸ªtopicå¯ä»¥æœ‰0ä¸ªæˆ–è€…1ä¸ªæˆ–è€…å¤šä¸ªç”Ÿäº§è€…å‘å…¶å‘é€æ¶ˆæ¯ï¼Œæ¢å¥è¯è¯´ï¼Œä¸€ä¸ªç”Ÿäº§è€…å¯ä»¥åŒæ—¶å‘ä¸åŒå’Œtopicå‘é€æ¶ˆæ¯ã€‚ä»æ¶ˆè´¹è€…çš„è§£åº¦æ¥è¯´ï¼Œä¸€ä¸ªtopicå¯èƒ½è¢«0ä¸ªæˆ–è€…ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ¶ˆè´¹ç»„è®¢é˜…ï¼Œç±»ä¼¼çš„ï¼Œä¸€ä¸ªæ¶ˆè´¹ç»„å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸»é¢˜åªè¦è¿™ä¸ªæ¶ˆè´¹ç»„çš„å®ä¾‹ä¿æŒä»–ä»¬çš„è®¢é˜…ä¸€è‡´ã€‚</p>
<p><strong>Message Orderï¼šå½“ä½¿ç”¨DefaultMQPushConsumeræ—¶ï¼Œä½ éœ€è¦ç¡®å®šæ¶ˆè´¹æ¶ˆæ¯çš„æ–¹å¼ï¼š</strong></p>
<blockquote>
<p>Orderlyï¼šé¡ºåºåœ°æ¶ˆè´¹æ¶ˆæ¯å³è¡¨ç¤ºæ¶ˆè´¹çš„æ¶ˆæ¯é¡ºåºåŒç”Ÿäº§è€…å‘é€çš„é¡ºåºä¸€è‡´ã€‚<br> Concurrentlyï¼šå¹¶è¡Œæ¶ˆè´¹ã€‚æŒ‡å®šæ­¤æ–¹å¼æ¶ˆè´¹ï¼Œä¿¡æ¯æ¶ˆè´¹çš„æœ€å¤§å¹¶è¡Œæ•°é‡ä»…å—é™äºæ¯ä¸ªæ¶ˆè´¹è€…å®¢æˆ·ç«¯æŒ‡å®šçš„çº¿ç¨‹æ± ã€‚</p>
</blockquote>
<p><strong>Consumer Groupï¼šæ¶ˆè´¹ç»„ï¼Œ</strong>åŒä¸€ç±»Consumerçš„é›†åˆï¼Œè¿™ç±»Consumeré€šå¸¸æ¶ˆè´¹åŒä¸€ç±»æ¶ˆæ¯ä¸”æ¶ˆè´¹é€»è¾‘ä¸€è‡´ã€‚æ¶ˆè´¹è€…ç»„ä½¿å¾—åœ¨æ¶ˆæ¯æ¶ˆè´¹æ–¹é¢ï¼Œå®ç°è´Ÿè½½å‡è¡¡å’Œå®¹é”™çš„ç›®æ ‡å˜å¾—éå¸¸å®¹æ˜“ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹è€…å®ä¾‹å¿…é¡»è®¢é˜…å®Œå…¨ç›¸åŒçš„Topicã€‚RocketMQ æ”¯æŒä¸¤ç§æ¶ˆæ¯æ¨¡å¼ï¼šé›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰å’Œå¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰ã€‚<br><strong>Producer Group:ç”Ÿäº§è€…ç»„ï¼Œ</strong>åŒä¸€ç±»Producerçš„é›†åˆï¼Œè¿™ç±»Producerå‘é€åŒä¸€ç±»æ¶ˆæ¯ä¸”å‘é€é€»è¾‘ä¸€è‡´ã€‚å¦‚æœå‘é€çš„æ˜¯äº‹åŠ¡æ¶ˆæ¯ä¸”åŸå§‹ç”Ÿäº§è€…åœ¨å‘é€ä¹‹åå´©æºƒï¼Œåˆ™BrokeræœåŠ¡å™¨ä¼šè”ç³»åŒä¸€ç”Ÿäº§è€…ç»„çš„å…¶ä»–ç”Ÿäº§è€…å®ä¾‹ä»¥æäº¤æˆ–å›æº¯æ¶ˆè´¹ã€‚</p>
<p>ä¸Šé¢çš„è¿™äº›æˆ‘ä¸»è¦å‚è€ƒäº† RocketMQ çš„ GitHub ä»‹ç»å’Œä¸€äº›ä¼˜ç§€ç½‘æ–‡çš„ä»‹ç»ï¼Œä¾µæƒè¯·è”ç³»æˆ‘åˆ é™¤ã€‚</p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Nicksxs"
      src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">Nicksxs</p>
  <div class="site-description" itemprop="description">learn from zero,æŠ€æœ¯åšå®¢ï¼ŒNicksxsï¼Œå²å­¦æ£®</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">104</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">131</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">207</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/nicksxs" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;nicksxs" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:nicksxs1202@gmail.com" title="E-Mail â†’ mailto:nicksxs1202@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>

  <script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
  <script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
  <div class="widget-wrap">
    <div id="myCanvasContainer" class="widget tagcloud">
      <canvas width="250" height="250" id="resCanvas" style="width=100%">
        <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/2019/" rel="tag">2019</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/2020/" rel="tag">2020</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/2021/" rel="tag">2021</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/2PC/" rel="tag">2PC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/360-%E5%85%A8%E5%AE%B6%E6%A1%B6/" rel="tag">360 å…¨å®¶æ¡¶</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/3PC/" rel="tag">3PC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/" rel="tag">AOP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Adaptive/" rel="tag">Adaptive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apollo/" rel="tag">Apollo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Binary-Tree/" rel="tag">Binary Tree</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Broker/" rel="tag">Broker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CachedThreadPool/" rel="tag">CachedThreadPool</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Comparator/" rel="tag">Comparator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DFS/" rel="tag">DFS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DP/" rel="tag">DP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DefaultMQPushConsumer/" rel="tag">DefaultMQPushConsumer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Design-Patterns/" rel="tag">Design Patterns</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Distributed-Lock/" rel="tag">Distributed Lock</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dockerfile/" rel="tag">Dockerfile</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dubbo/" rel="tag">Dubbo</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EagerThreadPool/" rel="tag">EagerThreadPool</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Filter/" rel="tag">Filter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FixedThreadPool/" rel="tag">FixedThreadPool</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/G1/" rel="tag">G1</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GC/" rel="tag">GC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Garbage-First-Collector/" rel="tag">Garbage-First Collector</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gogs/" rel="tag">Gogs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Homebrew/" rel="tag">Homebrew</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Inorder-Traversal/" rel="tag">Inorder Traversal</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Interceptor/" rel="tag">Interceptor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JMap/" rel="tag">JMap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JPS/" rel="tag">JPS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JStack/" rel="tag">JStack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LimitedThreadPool/" rel="tag">LimitedThreadPool</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linked-List/" rel="tag">Linked List</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lowest-Common-Ancestor-of-a-Binary-Tree/" rel="tag">Lowest Common Ancestor of a Binary Tree</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac/" rel="tag">Mac</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/" rel="tag">Maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NameServer/" rel="tag">NameServer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Preorder-Traversal/" rel="tag">Preorder Traversal</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketMQ/" rel="tag">RocketMQ</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rotate-Image/" rel="tag">Rotate Image</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rust/" rel="tag">Rust</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SPI/" rel="tag">SPI</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Servlet/" rel="tag">Servlet</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Singleton/" rel="tag">Singleton</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sql%E6%B3%A8%E5%85%A5/" rel="tag">Sqlæ³¨å…¥</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stream/" rel="tag">Stream</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Thread-dump/" rel="tag">Thread dump</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ThreadPool/" rel="tag">ThreadPool</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webhook/" rel="tag">Webhook</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aqs/" rel="tag">aqs</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/await/" rel="tag">await</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bloom-filter/" rel="tag">bloom filter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cgroup/" rel="tag">cgroup</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cluster/" rel="tag">cluster</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/condition/" rel="tag">condition</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/echo/" rel="tag">echo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/environment/" rel="tag">environment</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gap-lock/" rel="tag">gap lock</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gc/" rel="tag">gc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grep/" rel="tag">grep</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/" rel="tag">hadoop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/icu4c/" rel="tag">icu4c</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/im/" rel="tag">im</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/is-not-null/" rel="tag">is not null</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/is-null/" rel="tag">is null</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/j-u-c/" rel="tag">j.u.c</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">jvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a><span class="tag-list-count">24</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode-155/" rel="tag">leetcode 155</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linked-list/" rel="tag">linked list</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lock/" rel="tag">lock</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mfc/" rel="tag">mfc</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/min-stack/" rel="tag">min stack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mq/" rel="tag">mq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvcc/" rel="tag">mvcc</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/namespace/" rel="tag">namespace</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/next-key-lock/" rel="tag">next-key lock</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nullsfirst/" rel="tag">nullsfirst</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openresty/" rel="tag">openresty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/procedure/" rel="tag">procedure</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/read-view/" rel="tag">read view</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/signal/" rel="tag">signal</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/" rel="tag">sort</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/" rel="tag">spark</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stack/" rel="tag">stack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/string/" rel="tag">string</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swoole/" rel="tag">swoole</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/top/" rel="tag">top</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uname/" rel="tag">uname</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unlock/" rel="tag">unlock</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/value/" rel="tag">value</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/websocket/" rel="tag">websocket</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zsh/" rel="tag">zsh</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4/" rel="tag">ä¸‰é˜¶æ®µæäº¤</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%BC%95%E7%94%A8/" rel="tag">ä¸å¯å˜å¼•ç”¨</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4/" rel="tag">ä¸¤é˜¶æ®µæäº¤</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E5%B1%B1%E8%B7%AF/" rel="tag">ä¸­å±±è·¯</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E5%BA%8F/" rel="tag">ä¸­åº</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">ä¸­é—´ä»¶</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" rel="tag">äºŒå‰æ ‘</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%92%E6%96%A5%E9%94%81/" rel="tag">äº’æ–¥é”</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BF%AE%E7%94%B5%E8%84%91%E7%9A%84/" rel="tag">ä¿®ç”µè„‘çš„</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%81%A5%E5%BA%B7%E7%A0%81/" rel="tag">å¥åº·ç </a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%AC%E4%BA%A4/" rel="tag">å…¬äº¤</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%AC%E4%BA%A4%E8%BD%A6/" rel="tag">å…¬äº¤è½¦</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E5%B8%83/" rel="tag">å†…å­˜åˆ†å¸ƒ</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%8F%E8%82%A5/" rel="tag">å‡è‚¥</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" rel="tag">åˆ†å¸ƒå¼äº‹åŠ¡</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" rel="tag">åˆ†å¸ƒå¼é”</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%87%E7%89%87/" rel="tag">åˆ‡ç‰‡</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8A%E5%B3%B0%E5%A1%AB%E8%B0%B7/" rel="tag">å‰Šå³°å¡«è°·</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E5%BA%8F/" rel="tag">å‰åº</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A0%E5%A1%9E/" rel="tag">åŠ å¡</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E4%BE%8B/" rel="tag">å•ä¾‹</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2%EF%BC%8C%E6%96%87%E7%AB%A0/" rel="tag">åšå®¢ï¼Œæ–‡ç« </a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8E%A6%E9%97%A8/" rel="tag">å¦é—¨</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%91%E8%A1%8C%E7%89%88/" rel="tag">å‘è¡Œç‰ˆ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%A3%E7%BD%A9/" rel="tag">å£ç½©</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%AF%E5%8F%98%E5%BC%95%E7%94%A8/" rel="tag">å¯å˜å¼•ç”¨</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%90%E6%A7%BD/" rel="tag">åæ§½</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" rel="tag">åƒåœ¾å›æ”¶</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD/" rel="tag">åŸºç¡€è®¾æ–½</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6/" rel="tag">å®¹é”™æœºåˆ¶</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%84%E7%94%9F%E8%99%AB/" rel="tag">å¯„ç”Ÿè™«</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E6%8A%80%E5%B7%A7/" rel="tag">å°æŠ€å·§</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B1%80%E5%8F%A3%E8%A1%97/" rel="tag">å±€å£è¡—</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" rel="tag">å¸ƒéš†è¿‡æ»¤å™¨</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B2%E6%B4%BB/" rel="tag">å¹²æ´»</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B4%E4%B8%AD%E6%80%BB%E7%BB%93/" rel="tag">å¹´ä¸­æ€»ç»“</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" rel="tag">å¹´ç»ˆæ€»ç»“</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">å¹¶å‘</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B8%E7%A6%8F%E4%BA%86%E5%90%97/" rel="tag">å¹¸ç¦äº†å—</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%BB%E8%AF%BB/" rel="tag">å¹»è¯»</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E8%BD%A6/" rel="tag">å¼€è½¦</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BD%B1%E8%AF%84/" rel="tag">å½±è¯„</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%89%80%E6%9C%89%E6%9D%83/" rel="tag">æ‰€æœ‰æƒ</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%89%93%E5%8D%A1/" rel="tag">æ‰“å¡</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8B%96%E6%9B%B4/" rel="tag">æ‹–æ›´</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%92%E5%BA%8F/" rel="tag">æ’åº</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">æ•°æ®ç»“æ„</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%B0%E8%AF%AD%E8%A8%80/" rel="tag">æ–°è¯­è¨€</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%85%E6%B8%B8/" rel="tag">æ—…æ¸¸</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9B%BE%E5%8E%9D%E5%9E%B5/" rel="tag">æ›¾ååµ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%80%E5%B0%8F%E6%A0%88/" rel="tag">æœ€å°æ ˆ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%80%E4%BA%BA%E8%AF%9B%E5%BF%83/" rel="tag">æ€äººè¯›å¿ƒ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%AD%E5%B7%9E/" rel="tag">æ­å·</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86/" rel="tag">æ ‡è®°æ•´ç†</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A4%8D%E7%89%A9%E5%9B%AD/" rel="tag">æ¤ç‰©å›­</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B2%99%E8%8C%B6%E9%9D%A2/" rel="tag">æ²™èŒ¶é¢</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E8%A7%A3/" rel="tag">æ³¨è§£</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%B7%E8%9B%8E%E7%85%8E/" rel="tag">æµ·è›ç…</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag">æ¶ˆæ¯é˜Ÿåˆ—</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">æºç </a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag">æºç è§£æ</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB/" rel="tag">ç”Ÿæ´»</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%96%AB%E6%83%85/" rel="tag">ç–«æƒ…</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9F%A9%E9%98%B5/" rel="tag">çŸ©é˜µ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B3%9F%E5%BF%83%E4%BA%8B/" rel="tag">ç³Ÿå¿ƒäº‹</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B4%A2%E5%BC%95/" rel="tag">ç´¢å¼•</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">çº¿ç¨‹æ± </a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">ç¼“å­˜</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF/" rel="tag">ç¼“å­˜å‡»ç©¿</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F/" rel="tag">ç¼“å­˜ç©¿é€</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9/" rel="tag">ç¼“å­˜é›ªå´©</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BE%8E%E5%9B%BD/" rel="tag">ç¾å›½</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%80%81%E7%94%B5%E8%84%91/" rel="tag">è€ç”µè„‘</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%87%AA%E9%80%82%E5%BA%94%E6%8B%93%E5%B1%95/" rel="tag">è‡ªé€‚åº”æ‹“å±•</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%85%E7%94%B5%E8%84%91/" rel="tag">è£…ç”µè„‘</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%84%E5%88%99/" rel="tag">è§„åˆ™</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">è®¾è®¡æ¨¡å¼</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6/" rel="tag">è¯»ä¹¦</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E5%90%8E%E6%84%9F/" rel="tag">è¯»åæ„Ÿ</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B6%B3%E7%90%83/" rel="tag">è¶³çƒ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B7%91%E6%AD%A5/" rel="tag">è·‘æ­¥</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B7%AF%E6%94%BF%E8%A7%84%E5%88%92/" rel="tag">è·¯æ”¿è§„åˆ’</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E4%B9%89/" rel="tag">è½¬ä¹‰</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%90%E5%8A%A8/" rel="tag">è¿åŠ¨</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%92%E5%BD%92/" rel="tag">é€’å½’</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A2%98%E8%A7%A3/" rel="tag">é¢˜è§£</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A9%AC%E6%88%8F%E5%9B%A2/" rel="tag">é©¬æˆå›¢</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%AB%98%E9%80%9F/" rel="tag">é«˜é€Ÿ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%BC%93%E6%B5%AA%E5%B1%BF/" rel="tag">é¼“æµªå±¿</a><span class="tag-list-count">1</span></li></ul>
      </canvas>
    </div>
  </div>



  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://covermusic.cn/" title="https:&#x2F;&#x2F;covermusic.cn" rel="noopener" target="_blank">69ä¼™ä¼´</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Nicksxs</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"ysza182Vghlqjdt7QiwGLLJy-gzGzoHsz","app_key":"s9GDqbn7gnGGkusf66YRVccw","server_url":"https://leancloud.cn","security":true};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://nicksxs.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
